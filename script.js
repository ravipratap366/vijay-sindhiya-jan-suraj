// Runnisaidpur Voter Data (Sample)

const realVoterDataSample = [
  {
    serial: 1,
    voter_id: "WHD2526531",
    name: "рдХреГрд╖реНрдгрд╛ рджреЗрд╡реА",
    name_en: "Krishna Devi",
    father_name: "рд╡рд┐рдЬрдп рдорд╣рддреЛ",
    father_name_en: "Vijay Mahto",
    age: 41,
    gender: "F",
    address: "рдЧрд╛рдВрд╡ - рдкреНрд░реЗрдордирдЧрд░ рд╕реБрд╣рдИ",
    address_en: "Village - Premnagar Suhai",
    tehsil: "рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░",
    tehsil_en: "Runnisaidpur",
    post_office: "рдкреНрд░реЗрдордирдЧрд░ рд╕реБрд╣рдИ",
    post_office_en: "Premnagar Suhai",
    booth: "001",
    house_no: "00",
  },
  {
    serial: 2,
    voter_id: "WHD2543502",
    name: "рд▓рдВрдмреВ рдкрд╛рд╕рд╡рд╛рди",
    name_en: "Lambu Paswan",
    father_name: "рд░рд╛рдорд╕рд╛рдЧрд░ рдкрд╛рд╕рд╡рд╛рди",
    father_name_en: "Ramsagar Paswan",
    age: 30,
    gender: "M",
    address: "рдЧрд╛рдВрд╡ - рдкреНрд░реЗрдордирдЧрд░ рд╕реБрд╣рдИ",
    address_en: "Village - Premnagar Suhai",
    tehsil: "рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░",
    tehsil_en: "Runnisaidpur",
    post_office: "рдкреНрд░реЗрдордирдЧрд░ рд╕реБрд╣рдИ",
    post_office_en: "Premnagar Suhai",
    booth: "001",
    house_no: "00",
  },
  {
    serial: 3,
    voter_id: "WHD2519007",
    name: "рдмрдмрд┐рддрд╛ рджреЗрд╡реА",
    name_en: "Babita Devi",
    father_name: "рдордиреЛрдЬ рд╕рд╛рд╣",
    father_name_en: "Manoj Sah",
    age: 29,
    gender: "F",
    address: "рдЧрд╛рдВрд╡ - рдкреНрд░реЗрдордирдЧрд░ рд╕реБрд╣рдИ",
    address_en: "Village - Premnagar Suhai",
    tehsil: "рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░",
    tehsil_en: "Runnisaidpur",
    post_office: "рдкреНрд░реЗрдордирдЧрд░ рд╕реБрд╣рдИ",
    post_office_en: "Premnagar Suhai",
    booth: "001",
    house_no: "00",
  },
  {
    serial: 4,
    voter_id: "WHD2524510",
    name: "рдЪрд╛рдВрджрдиреА рдХреБрдорд╛рд░реА",
    name_en: "Chandni Kumari",
    father_name: "рд╕реБрдмреЛрдз рд╕рд╛рд╣",
    father_name_en: "Subodh Sah",
    age: 27,
    gender: "F",
    address: "рдЧрд╛рдВрд╡ - рдкреНрд░реЗрдордирдЧрд░ рд╕реБрд╣рдИ",
    address_en: "Village - Premnagar Suhai",
    tehsil: "рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░",
    tehsil_en: "Runnisaidpur",
    post_office: "рдкреНрд░реЗрдордирдЧрд░ рд╕реБрд╣рдИ",
    post_office_en: "Premnagar Suhai",
    booth: "001",
    house_no: "00",
  },
  {
    serial: 5,
    voter_id: "WHD2543346",
    name: "рд░рд┐рдВрдХреА рджреЗрд╡реА",
    name_en: "Rinki Devi",
    father_name: "рд▓рдВрдмреВ рдкрд╛рд╕рд╡рд╛рди",
    father_name_en: "Lambu Paswan",
    age: 27,
    gender: "F",
    address: "рдЧрд╛рдВрд╡ - рдкреНрд░реЗрдордирдЧрд░ рд╕реБрд╣рдИ",
    address_en: "Village - Premnagar Suhai",
    tehsil: "рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░",
    tehsil_en: "Runnisaidpur",
    post_office: "рдкреНрд░реЗрдордирдЧрд░ рд╕реБрд╣рдИ",
    post_office_en: "Premnagar Suhai",
    booth: "001",
    house_no: "00",
  },
  {
    serial: 6,
    voter_id: "WHD2526895",
    name: "рд░рдВрдЬрдп рдХреБрдорд╛рд░",
    name_en: "Ranjay Kumar",
    father_name: "рдирдВрдж рдХрд┐рд╢реЛрд░ рдкрд╛рд╕рд╡рд╛рди",
    father_name_en: "Nand Kishor Paswan",
    age: 23,
    gender: "M",
    address: "рдЧрд╛рдВрд╡ - рдкреНрд░реЗрдордирдЧрд░ рд╕реБрд╣рдИ",
    address_en: "Village - Premnagar Suhai",
    tehsil: "рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░",
    tehsil_en: "Runnisaidpur",
    post_office: "рдкреНрд░реЗрдордирдЧрд░ рд╕реБрд╣рдИ",
    post_office_en: "Premnagar Suhai",
    booth: "001",
    house_no: "00",
  },
  {
    serial: 7,
    voter_id: "WHD2518777",
    name: "рд╢рд┐рд╡рдо рдХреБрдорд╛рд░",
    name_en: "Shivam Kumar",
    father_name: "рднреЛрд▓рд╛ рдордВрдбрд▓",
    father_name_en: "Bhola Mandal",
    age: 21,
    gender: "M",
    address: "рдЧрд╛рдВрд╡ - рдкреНрд░реЗрдордирдЧрд░ рд╕реБрд╣рдИ",
    address_en: "Village - Premnagar Suhai",
    tehsil: "рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░",
    tehsil_en: "Runnisaidpur",
    post_office: "рдкреНрд░реЗрдордирдЧрд░ рд╕реБрд╣рдИ",
    post_office_en: "Premnagar Suhai",
    booth: "001",
    house_no: "00",
  },
  {
    serial: 8,
    voter_id: "WHD1629005",
    name: "рдмрдмрд┐рддрд╛ рджреЗрд╡реА",
    name_en: "Babita Devi",
    father_name: "рдмреБрдзреБ рдордВрдбрд▓",
    father_name_en: "Budhu Mandal",
    age: 36,
    gender: "F",
    address: "рдЧрд╛рдВрд╡ - рдкреНрд░реЗрдордирдЧрд░ рд╕реБрд╣рдИ",
    address_en: "Village - Premnagar Suhai",
    tehsil: "рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░",
    tehsil_en: "Runnisaidpur",
    post_office: "рдкреНрд░реЗрдордирдЧрд░ рд╕реБрд╣рдИ",
    post_office_en: "Premnagar Suhai",
    booth: "001",
    house_no: "3",
  },
  {
    serial: 9,
    voter_id: "WHD2451672",
    name: "рд╕реБрдиреАрд▓рд╛ рдХреБрдорд╛рд░реА",
    name_en: "Sunila Kumari",
    father_name: "рдкрдкреНрдкреВ рдХреБрдорд╛рд░",
    father_name_en: "Pappu Kumar",
    age: 22,
    gender: "F",
    address: "рдЧрд╛рдВрд╡ - рдкреНрд░реЗрдордирдЧрд░ рд╕реБрд╣рдИ",
    address_en: "Village - Premnagar Suhai",
    tehsil: "рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░",
    tehsil_en: "Runnisaidpur",
    post_office: "рдкреНрд░реЗрдордирдЧрд░ рд╕реБрд╣рдИ",
    post_office_en: "Premnagar Suhai",
    booth: "001",
    house_no: "3",
  },
  {
    serial: 10,
    voter_id: "WHD0015495",
    name: "рд░рд╛рдЬреВ рд╕рд╛рд╣",
    name_en: "Raju Sah",
    father_name: "рд╕реАрддрд╛рд░рд╛рдо рд╕рд╛рд╣",
    father_name_en: "Sitaram Sah",
    age: 48,
    gender: "M",
    address: "рдЧрд╛рдВрд╡ - рдкреНрд░реЗрдордирдЧрд░ рд╕реБрд╣рдИ",
    address_en: "Village - Premnagar Suhai",
    tehsil: "рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░",
    tehsil_en: "Runnisaidpur",
    post_office: "рдкреНрд░реЗрдордирдЧрд░ рд╕реБрд╣рдИ",
    post_office_en: "Premnagar Suhai",
    booth: "001",
    house_no: "4",
  },
  {
    serial: 11,
    voter_id: "WHD3847592",
    name: "рд░рд╡рд┐ рдкреНрд░рддрд╛рдк",
    name_en: "Ravi Pratap",
    father_name: "рд░рд╛рдо рдкреНрд░рдХрд╛рд╢",
    father_name_en: "Ram Prakash",
    age: 32,
    gender: "M",
    address: "рдЧрд╛рдВрд╡ - рдмрдШрд╛рдбрд╝реА",
    address_en: "Village - Baghadi",
    tehsil: "рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░",
    tehsil_en: "Runnisaidpur",
    post_office: "рдмрдШрд╛рдбрд╝реА",
    post_office_en: "Baghadi",
    booth: "002",
    house_no: "15",
  },
  {
    serial: 12,
    voter_id: "WHD2847193",
    name: "рдкреНрд░рд┐рдпрд╛ рд╕рд┐рдВрд╣",
    name_en: "Priya Singh",
    father_name: "рдЕрдЬрдп рд╕рд┐рдВрд╣",
    father_name_en: "Ajay Singh",
    age: 28,
    gender: "F",
    address: "рдЧрд╛рдВрд╡ - рдорд╛рдирд┐рдХ рдЪреМрдХ",
    address_en: "Village - Manik Chauk",
    tehsil: "рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░",
    tehsil_en: "Runnisaidpur",
    post_office: "рдорд╛рдирд┐рдХ рдЪреМрдХ",
    post_office_en: "Manik Chauk",
    booth: "005",
    house_no: "22",
  },
  {
    serial: 13,
    voter_id: "WHD2947583",
    name: "рдЕрдирд┐рд▓ рдХреБрдорд╛рд░",
    name_en: "Anil Kumar",
    father_name: "рд▓рд╛рд▓ рдмрд╣рд╛рджреБрд░",
    father_name_en: "Lal Bahadur",
    age: 35,
    gender: "M",
    address: "рдЧрд╛рдВрд╡ - рдЧреМрдбрд╝рд╛",
    address_en: "Village - Gauda",
    tehsil: "рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░",
    tehsil_en: "Runnisaidpur",
    post_office: "рдЧреМрдбрд╝рд╛",
    post_office_en: "Gauda",
    booth: "003",
    house_no: "08",
  },
  {
    serial: 14,
    voter_id: "WHD2637481",
    name: "рд╕реБрдорд┐рддреНрд░рд╛ рджреЗрд╡реА",
    name_en: "Sumitra Devi",
    father_name: "рдЧреЛрдкрд╛рд▓ рд╕рд╛рд╣",
    father_name_en: "Gopal Sah",
    age: 45,
    gender: "F",
    address: "рдЧрд╛рдВрд╡ - рдЕрдерд░реА",
    address_en: "Village - Athari",
    tehsil: "рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░",
    tehsil_en: "Runnisaidpur",
    post_office: "рдЕрдерд░реА",
    post_office_en: "Athari",
    booth: "010",
    house_no: "12",
  },
  {
    serial: 15,
    voter_id: "WHD2745629",
    name: "рд░рд╛рд╣реБрд▓ рдорд┐рд╢реНрд░рд╛",
    name_en: "Rahul Mishra",
    father_name: "рд╡рд┐рдиреЛрдж рдорд┐рд╢реНрд░рд╛",
    father_name_en: "Vinod Mishra",
    age: 26,
    gender: "M",
    address: "рдЧрд╛рдВрд╡ - рд░рд╛рдпрдкреБрд░",
    address_en: "Village - Raipur",
    tehsil: "рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░",
    tehsil_en: "Runnisaidpur",
    post_office: "рд░рд╛рдпрдкреБрд░",
    post_office_en: "Raipur",
    booth: "015",
    house_no: "05",
  },
  {
    serial: 16,
    voter_id: "WHD2139061",
    name: "рд░рд╡рд┐ рдкреНрд░рддрд╛рдк",
    name_en: "Ravi Pratap",
    father_name: "рд╡рд┐рдЬрдп рдХреБрдорд╛рд░ рд╕рд╛рд╣",
    father_name_en: "Vijay Kumar Sah",
    age: 26,
    gender: "M",
    address: "рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░",
    address_en: "Runnisaidpur",
    tehsil: "рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░",
    tehsil_en: "Runnisaidpur",
    post_office: "рд░реВрдиреНрдиреАрд╕реИрджрдкреБрд░",
    post_office_en: "Runnisaidpur",
    booth: "270",
    house_no: "рд░реБрдиреАрд╕реИрджрдкреБрд░",
  },
];

// Global variables for chunked data system
let voterChunkIndex = null;
let loadedChunks = new Map();
let voterData = []; // Fallback to sample data
let searchStats = {
  totalVoters: 277703, // Updated from actual database
  lastSearchResults: 0,
  totalMale: 147941, // Real official male count
  totalFemale: 129666, // Real official female count
};

// Initialize chunked data system
async function initializeChunkedData() {
  try {
    console.log("Loading voter chunk index...");
    const response = await fetch("voter-chunks/index.json");

    if (!response.ok) {
      console.log("Chunk index not found, using sample data");
      return false;
    }

    voterChunkIndex = await response.json();
    console.log(
      `Loaded chunk index: ${voterChunkIndex.metadata.total_chunks} chunks, ${voterChunkIndex.metadata.total_records} total records`
    );

    // Update UI with actual statistics
    const totalVotersEl = document.getElementById("totalVoters");
    if (totalVotersEl) {
      totalVotersEl.textContent =
        voterChunkIndex.metadata.total_records.toLocaleString("hi-IN");
    }

    return true;
  } catch (error) {
    console.error("Error loading chunk index:", error);
    return false;
  }
}

// Load a specific chunk
async function loadChunk(chunkId) {
  if (loadedChunks.has(chunkId)) {
    return loadedChunks.get(chunkId);
  }

  try {
    const response = await fetch(
      `voter-chunks/chunk-${chunkId.toString().padStart(3, "0")}.json`
    );
    if (!response.ok) {
      throw new Error(`Chunk ${chunkId} not found`);
    }

    const chunkData = await response.json();
    loadedChunks.set(chunkId, chunkData.voters);
    console.log(`Loaded chunk ${chunkId}: ${chunkData.voters.length} records`);

    return chunkData.voters;
  } catch (error) {
    console.error(`Error loading chunk ${chunkId}:`, error);
    return [];
  }
}

// Chunked search function
async function performChunkedSearch(searchTerm) {
  if (!voterChunkIndex) {
    // Fallback to sample data
    return universalSearch(searchTerm);
  }

  const rankedResults = [];
  const normalizedTerm = searchTerm.toLowerCase().trim().replace(/\s+/g, " ");
  const MAX_RESULTS = 15; // Show top 15 best matches
  const MIN_SCORE_THRESHOLD = 15; // Minimum relevance score to include

  // Show loading indicator
  const resultsDiv = document.getElementById("searchResults");
  if (resultsDiv) {
    resultsDiv.innerHTML =
      '<div class="loading">ЁЯФН рдЦреЛрдЬ рд░рд╣реЗ рд╣реИрдВ... рдХреГрдкрдпрд╛ рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░реЗрдВ</div>';
  }

  try {
    let chunksProcessed = 0;
    let exactMatches = [];
    let goodMatches = [];
    let partialMatches = [];

    // Search through chunks efficiently with progressive filtering
    for (let i = 0; i < voterChunkIndex.metadata.total_chunks; i++) {
      const chunkData = await loadChunk(i);

      if (!chunkData || chunkData.length === 0) {
        continue;
      }

      // Search within this chunk with ranking
      for (const voter of chunkData) {
        if (!voter || !voter.n) continue; // Skip invalid records

        const relevance = calculateRelevanceScore(voter, normalizedTerm);

        if (relevance >= MIN_SCORE_THRESHOLD) {
          const result = { voter, relevance };

          // Categorize results for better sorting
          if (relevance >= 90) {
            exactMatches.push(result);
          } else if (relevance >= 60) {
            goodMatches.push(result);
          } else {
            partialMatches.push(result);
          }
        }
      }

      chunksProcessed++;

      // Show progress for large searches
      if (chunksProcessed % 3 === 0) {
        const progress = Math.round(
          (chunksProcessed / voterChunkIndex.metadata.total_chunks) * 100
        );
        if (resultsDiv) {
          resultsDiv.innerHTML = `<div class="loading">ЁЯФН рдЦреЛрдЬ рд░рд╣реЗ рд╣реИрдВ... ${progress}% рдкреВрд░реНрдг (${
            exactMatches.length + goodMatches.length + partialMatches.length
          } рдорд┐рд▓реЗ)</div>`;
        }
      }

      // Early termination conditions
      const totalFound =
        exactMatches.length + goodMatches.length + partialMatches.length;

      // If we have enough exact matches, stop searching
      if (exactMatches.length >= MAX_RESULTS) {
        console.log(
          `Found ${exactMatches.length} exact matches, stopping search early`
        );
        break;
      }

      // If we have a good number of high-quality results and processed significant chunks
      if (
        totalFound >= MAX_RESULTS * 2 &&
        chunksProcessed >=
          Math.min(20, voterChunkIndex.metadata.total_chunks * 0.4)
      ) {
        console.log(
          `Found ${totalFound} results after processing ${chunksProcessed} chunks, stopping search`
        );
        break;
      }
    }

    // Combine results with priority: exact matches first, then good matches, then partial
    rankedResults.push(...exactMatches, ...goodMatches, ...partialMatches);

    // Sort by relevance and take top results only
    rankedResults.sort((a, b) => b.relevance - a.relevance);
    const topResults = rankedResults.slice(0, MAX_RESULTS);

    return topResults.map((result) => ({
      // Convert optimized format back to full format
      serial: result.voter.i || 0,
      voter_id: result.voter.v || "",
      name: result.voter.n || "",
      name_en: result.voter.n || "",
      father_name: result.voter.g || "",
      father_name_en: result.voter.g || "",
      age: result.voter.a || 0,
      gender: result.voter.s || "",
      address: result.voter.po || result.voter.p || "",
      address_en: result.voter.po || result.voter.p || "",
      tehsil: result.voter.t || "рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░",
      tehsil_en: result.voter.t || "Runnisaidpur",
      post_office: result.voter.po || "",
      post_office_en: result.voter.po || "",
      booth: result.voter.pn ? result.voter.pn.toString() : "",
      house_no: result.voter.h || "",
      relevance: result.relevance, // Keep for debugging
    }));
  } catch (error) {
    console.error("Error in chunked search:", error);
    return universalSearch(searchTerm); // Fallback to sample data
  }
}

// Enhanced relevance score calculation for comprehensive search
function calculateRelevanceScore(voter, searchTerm) {
  let score = 0;
  const term = searchTerm.toLowerCase().trim();
  const searchWords = term.split(" ").filter((word) => word.length > 0);

  // Get voter fields with null safety
  const name = (voter.n || "").toLowerCase().trim();
  const guardian = (voter.g || "").toLowerCase().trim();
  const voterId = (voter.v || "").toLowerCase().trim();
  const address = (voter.po || voter.p || "").toLowerCase().trim();
  const houseNo = (voter.h || "").toLowerCase().trim();
  const age = voter.a ? voter.a.toString() : "";
  const tehsil = (voter.t || "").toLowerCase().trim();

  // Exact name match (highest priority)
  if (name === term) {
    score += 100;
  }
  // Name starts with search term
  else if (name.startsWith(term)) {
    score += 90;
  }
  // Name contains search term
  else if (name.includes(term)) {
    score += 70;
  }
  // All search words found in name (any order)
  else if (
    searchWords.length > 1 &&
    searchWords.every((word) => name.includes(word))
  ) {
    score += 65;
  }
  // Partial name matches (surname, middle name, etc.)
  else {
    let partialMatches = 0;
    searchWords.forEach((word) => {
      if (word.length >= 2 && name.includes(word)) {
        partialMatches++;
        score += 20;
      }
    });
    // Bonus for multiple partial matches
    if (partialMatches > 1) {
      score += 15;
    }
  }

  // Exact voter ID match (very high priority)
  if (voterId === term) {
    score += 95;
  }
  // Voter ID contains search term
  else if (voterId.includes(term)) {
    score += 80;
  }

  // Guardian name matches
  if (guardian) {
    if (guardian.includes(term)) {
      score += 45;
    } else {
      // Check individual words in guardian name
      searchWords.forEach((word) => {
        if (word.length >= 3 && guardian.includes(word)) {
          score += 25;
        }
      });
    }
  }

  // House number matches
  if (houseNo && (houseNo === term || houseNo.includes(term))) {
    score += 50;
  }

  // Address matches
  if (address.includes(term)) {
    score += 35;
  }

  // Age match (if numeric search)
  if (age && age === term) {
    score += 40;
  }

  // Tehsil match
  if (tehsil.includes(term)) {
    score += 25;
  }

  // Cross-language and phonetic matching
  if (crossLanguageMatch(term, name) || crossLanguageMatch(term, guardian)) {
    score += 30;
  }

  // Fuzzy matching for common typos (basic implementation)
  if (term.length >= 4) {
    searchWords.forEach((word) => {
      if (word.length >= 4) {
        // Check for single character differences
        if (levenshteinDistance(word, name) <= 1) {
          score += 20;
        }
      }
    });
  }

  return Math.min(score, 100); // Cap at 100
}

// Simple Levenshtein distance for fuzzy matching
function levenshteinDistance(str1, str2) {
  const matrix = [];

  if (str1.length === 0) return str2.length;
  if (str2.length === 0) return str1.length;

  for (let i = 0; i <= str2.length; i++) {
    matrix[i] = [i];
  }

  for (let j = 0; j <= str1.length; j++) {
    matrix[0][j] = j;
  }

  for (let i = 1; i <= str2.length; i++) {
    for (let j = 1; j <= str1.length; j++) {
      if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
        matrix[i][j] = matrix[i - 1][j - 1];
      } else {
        matrix[i][j] = Math.min(
          matrix[i - 1][j - 1] + 1,
          matrix[i][j - 1] + 1,
          matrix[i - 1][j] + 1
        );
      }
    }
  }

  return matrix[str2.length][str1.length];
}

// Search within a single voter record (optimized format)
function searchInVoterRecord(voter, searchTerm) {
  const searchFields = [
    voter.n, // name
    voter.g, // guardian name
    voter.v, // voter_id
    voter.po, // post office
    voter.p, // polling station
    voter.t, // tehsil
    voter.h, // house number
    voter.a?.toString(), // age
  ];

  const searchWords = searchTerm.split(" ").filter((word) => word.length > 0);

  return searchFields.some((field) => {
    if (!field) return false;
    const fieldLower = field
      .toString()
      .toLowerCase()
      .trim()
      .replace(/\s+/g, " ");

    // Direct match
    if (fieldLower.includes(searchTerm)) return true;

    // Word-by-word matching
    if (searchWords.every((word) => fieldLower.includes(word))) return true;

    // Cross-language matching
    if (crossLanguageMatch(searchTerm, fieldLower)) return true;

    // Flexible spacing
    const termNoSpaces = searchTerm.replace(/\s+/g, "");
    const fieldNoSpaces = fieldLower.replace(/\s+/g, "");
    if (fieldNoSpaces.includes(termNoSpaces) && termNoSpaces.length > 2)
      return true;

    return false;
  });
}

// Initialize the application
document.addEventListener("DOMContentLoaded", function () {
  console.log("DOM loaded, initializing voter search...");

  // Initialize AOS (Animate On Scroll) with mobile-optimized settings
  if (typeof AOS !== "undefined") {
    AOS.init({
      duration: 600,
      easing: "ease-in-out",
      once: true,
      offset: 50, // Reduced offset for mobile
      disable: function () {
        return window.innerWidth < 480; // Disable on very small screens
      },
    });
  }

  // Mobile-specific optimizations
  initializeMobileOptimizations();

  // Initialize data systems
  initializeRealData();
  setupEventListeners();

  // Initialize chunked data system
  initializeChunkedData();
});

// Mobile optimizations
function initializeMobileOptimizations() {
  // Prevent zoom on input focus for iOS
  if (navigator.userAgent.match(/iPhone|iPad|iPod/i)) {
    const inputs = document.querySelectorAll(
      'input[type="text"], input[type="search"], textarea'
    );
    inputs.forEach((input) => {
      input.addEventListener("focus", function () {
        this.style.fontSize = "16px";
      });
    });
  }

  // Improve touch scrolling for mobile
  if ("ontouchstart" in window) {
    document.body.style.webkitOverflowScrolling = "touch";
  }

  // Close mobile menu when clicking outside
  document.addEventListener("click", function (event) {
    const navMenu = document.querySelector(".nav-menu");
    const hamburger = document.querySelector(".hamburger");

    if (
      navMenu &&
      hamburger &&
      !navMenu.contains(event.target) &&
      !hamburger.contains(event.target) &&
      navMenu.classList.contains("active")
    ) {
      navMenu.classList.remove("active");
      hamburger.classList.remove("active");
    }
  });

  // Auto-close mobile menu when link is clicked
  const navLinks = document.querySelectorAll(".nav-menu a");
  navLinks.forEach((link) => {
    link.addEventListener("click", function () {
      const navMenu = document.querySelector(".nav-menu");
      const hamburger = document.querySelector(".hamburger");

      if (navMenu && hamburger) {
        navMenu.classList.remove("active");
        hamburger.classList.remove("active");
      }
    });
  });
}

// Initialize with real voter data
function initializeRealData() {
  voterData = realVoterDataSample;
  updateRealVoterStats();
  displayRealDataInfo();
  console.log(
    "Real voter data loaded: 15 sample records from 279,729 total voters"
  );
}

// Update statistics with real data
function updateRealVoterStats() {
  // Update UI with official statistics
  const totalVotersEl = document.getElementById("totalVoters");
  const maleVotersEl = document.getElementById("maleVoters");
  const femaleVotersEl = document.getElementById("femaleVoters");

  if (totalVotersEl) totalVotersEl.textContent = "2,79,729";
  if (maleVotersEl) maleVotersEl.textContent = "1,47,941";
  if (femaleVotersEl) femaleVotersEl.textContent = "1,29,666";
}

// Display data information
function displayRealDataInfo() {
  const noteHTML = `
        <div class="simple-note" data-aos="fade-up">
            <div class="note-card">
                <div class="note-icon">ЁЯУК</div>
                <div class="note-content">
                    <h4>рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рдорддрджрд╛рддрд╛ рдбреЗрдЯрд╛рдмреЗрд╕</h4>
                    <p><strong>рд╕реНрд░реЛрдд:</strong> рднрд╛рд░рддреАрдп рдирд┐рд░реНрд╡рд╛рдЪрди рдЖрдпреЛрдЧ 2025 - рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░ рд╡рд┐рдзрд╛рдирд╕рднрд╛ рдХреНрд╖реЗрддреНрд░ 29</p>
                    <p><strong>рдХреБрд▓ рдорддрджрд╛рддрд╛:</strong> 2,79,729 (рдкреБрд░реБрд╖: 1,47,941 | рдорд╣рд┐рд▓рд╛: 1,29,666)</p>
                    <p><strong>рд╡рд░реНрддрдорд╛рди рд╕реНрдерд┐рддрд┐:</strong> рдкреВрд░реНрдг рдбреЗрдЯрд╛рдмреЗрд╕ - 2,77,703 рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдорддрджрд╛рддрд╛ рд░рд┐рдХреЙрд░реНрдб</p>
                </div>
            </div>
        </div>
    `;

  // Replace any existing data note
  const existingNote = document.querySelector(
    ".simple-note, .data-note, .data-info-section"
  );
  if (existingNote && existingNote.parentNode) {
    existingNote.parentNode.innerHTML = noteHTML;
  }
}

// Enhanced universal search with ranking
// function universalSearch(searchTerm) {
//   if (!searchTerm || searchTerm.trim().length === 0) return [];

//   // Normalize search term - remove extra spaces, convert to lowercase
//   const term = searchTerm.toLowerCase().trim().replace(/\s+/g, " ");
//   const MAX_RESULTS = 12; // Consistent with chunked search

//   // Calculate relevance scores for sample data
//   const rankedResults = voterData
//     .map((voter) => {
//       const relevance = calculateSampleDataRelevance(voter, term);
//       return { voter, relevance };
//     })
//     .filter((result) => result.relevance > 0);

//   // Sort by relevance and return top results
//   rankedResults.sort((a, b) => b.relevance - a.relevance);
//   return rankedResults.slice(0, MAX_RESULTS).map((result) => result.voter);
// }
async function universalSearch(searchTerm) {
  if (!searchTerm || searchTerm.trim().length === 0) return [];

  const term = searchTerm.toLowerCase().trim().replace(/\s+/g, " ");
  const MAX_RESULTS = 12;

  // Remote results
  let remoteResults = [];
  try {
    const url = `https://script.google.com/macros/s/AKfycbxeTD2UsL-rVtkp07IZ0GRf-_eurftOG9JGhTx--B05fiF3Mp9DypZiNVhK2FWbolDLXw/exec?q=${encodeURIComponent(
      searchTerm
    )}`;

    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const data = await res.json();

    if (Array.isArray(data)) {
      remoteResults = data.map((voter) => ({
        voter,
        relevance: calculateSampleDataRelevance(voter, term) || 1, // fallback relevance
      }));
    }
  } catch (err) {
    console.error("Remote fetch failed:", err.message);
  }

  // Sort & return top MAX_RESULTS
  remoteResults.sort((a, b) => b.relevance - a.relevance);
  return allResults.slice(0, MAX_RESULTS).map((r) => r.voter);
}

// Calculate relevance score for sample data format
function calculateSampleDataRelevance(voter, searchTerm) {
  let score = 0;
  const term = searchTerm.toLowerCase();
  const searchWords = term.split(" ").filter((word) => word.length > 0);

  // Get voter fields
  const name = (voter.name || "").toLowerCase();
  const nameEn = (voter.name_en || "").toLowerCase();
  const fatherName = (voter.father_name || "").toLowerCase();
  const voterId = (voter.voter_id || "").toLowerCase();
  const address = (voter.address || "").toLowerCase();
  const houseNo = (voter.house_no || "").toLowerCase();

  // Exact name match (highest priority)
  if (name === term || nameEn === term) {
    score += 100;
  }
  // Name starts with search term
  else if (name.startsWith(term) || nameEn.startsWith(term)) {
    score += 90;
  }
  // Name contains search term
  else if (name.includes(term) || nameEn.includes(term)) {
    score += 70;
  }
  // All search words found in name
  else if (
    searchWords.every((word) => name.includes(word) || nameEn.includes(word))
  ) {
    score += 60;
  }

  // Exact voter ID match
  if (voterId === term || voterId.includes(term)) {
    score += 85;
  }

  // Father name matches
  if (fatherName.includes(term)) {
    score += 40;
  }

  // House number exact match
  if (houseNo && houseNo === term) {
    score += 50;
  }

  // Address matches
  if (address.includes(term)) {
    score += 30;
  }

  // Cross-language matching
  if (crossLanguageMatch(term, name) || crossLanguageMatch(term, nameEn)) {
    score += 35;
  }

  // Partial word matches in name (at least 3 characters)
  if (term.length >= 3) {
    searchWords.forEach((word) => {
      if (word.length >= 3 && (name.includes(word) || nameEn.includes(word))) {
        score += 25;
      }
    });
  }

  return Math.min(score, 100); // Cap at 100
}

// Enhanced cross-language matching function
function crossLanguageMatch(searchTerm, fieldValue) {
  // Common Hindi-English name mappings
  const nameTranslations = {
    // Names
    ravi: ["рд░рд╡рд┐", "рд░рд╛рд╡реА"],
    рд░рд╡рд┐: ["ravi"],
    pratap: ["рдкреНрд░рддрд╛рдк", "рдкреНрд░рддрд╛рдк"],
    рдкреНрд░рддрд╛рдк: ["pratap"],
    ram: ["рд░рд╛рдо"],
    рд░рд╛рдо: ["ram"],
    prakash: ["рдкреНрд░рдХрд╛рд╢"],
    рдкреНрд░рдХрд╛рд╢: ["prakash"],
    krishna: ["рдХреГрд╖реНрдгрд╛", "рдХреГрд╖реНрдг"],
    рдХреГрд╖реНрдгрд╛: ["krishna"],
    рдХреГрд╖реНрдг: ["krishna"],
    devi: ["рджреЗрд╡реА"],
    рджреЗрд╡реА: ["devi"],
    kumar: ["рдХреБрдорд╛рд░"],
    рдХреБрдорд╛рд░: ["kumar"],
    singh: ["рд╕рд┐рдВрд╣"],
    рд╕рд┐рдВрд╣: ["singh"],
    sah: ["рд╕рд╛рд╣"],
    рд╕рд╛рд╣: ["sah"],
    mandal: ["рдордВрдбрд▓"],
    рдордВрдбрд▓: ["mandal"],
    paswan: ["рдкрд╛рд╕рд╡рд╛рди"],
    рдкрд╛рд╕рд╡рд╛рди: ["paswan"],
    mishra: ["рдорд┐рд╢реНрд░рд╛"],
    рдорд┐рд╢реНрд░рд╛: ["mishra"],

    // Places
    baghadi: ["рдмрдШрд╛рдбрд╝реА"],
    рдмрдШрд╛рдбрд╝реА: ["baghadi"],
    runnisaidpur: ["рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░"],
    рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░: ["runnisaidpur"],
    premnagar: ["рдкреНрд░реЗрдордирдЧрд░"],
    рдкреНрд░реЗрдордирдЧрд░: ["premnagar"],
    gauda: ["рдЧреМрдбрд╝рд╛"],
    рдЧреМрдбрд╝рд╛: ["gauda"],
    athari: ["рдЕрдерд░реА"],
    рдЕрдерд░реА: ["athari"],
    raipur: ["рд░рд╛рдпрдкреБрд░"],
    рд░рд╛рдпрдкреБрд░: ["raipur"],
    manik: ["рдорд╛рдирд┐рдХ"],
    рдорд╛рдирд┐рдХ: ["manik"],
    chauk: ["рдЪреМрдХ"],
    рдЪреМрдХ: ["chauk"],

    // Common words
    village: ["рдЧрд╛рдВрд╡", "рдЧреНрд░рд╛рдо"],
    рдЧрд╛рдВрд╡: ["village"],
    рдЧреНрд░рд╛рдо: ["village"],
  };

  // Normalize both search term and field value
  const normalizedSearch = searchTerm.toLowerCase().trim().replace(/\s+/g, " ");
  const normalizedField = fieldValue.toLowerCase().trim().replace(/\s+/g, " ");

  const searchWords = normalizedSearch
    .split(" ")
    .filter((word) => word.length > 0);

  for (const word of searchWords) {
    const translations = nameTranslations[word];
    if (translations) {
      for (const translation of translations) {
        const normalizedTranslation = translation.toLowerCase().trim();
        // Check both with spaces and without spaces
        if (
          normalizedField.includes(normalizedTranslation) ||
          normalizedField
            .replace(/\s+/g, "")
            .includes(normalizedTranslation.replace(/\s+/g, ""))
        ) {
          return true;
        }
      }
    }
  }

  return false;
}

// Setup event listeners
function setupEventListeners() {
  const searchBtn = document.getElementById("searchBtn");
  const searchInput = document.getElementById("voterSearch");

  console.log("Setting up event listeners...");
  console.log("Search button found:", !!searchBtn);
  console.log("Search input found:", !!searchInput);

  if (searchBtn) {
    searchBtn.addEventListener("click", function () {
      console.log("Search button clicked");
      performSearch();
    });
  } else {
    console.error("Search button not found!");
  }

  if (searchInput) {
    searchInput.addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
        console.log("Enter key pressed");
        performSearch();
      }
    });

    // Real-time search
    searchInput.addEventListener("input", function (e) {
      if (e.target.value.length >= 2) {
        console.log("Input search triggered:", e.target.value);
        performSearch();
      } else if (e.target.value.length === 0) {
        clearResults();
      }
    });
  } else {
    console.error("Search input not found!");
  }
}

// Perform search (updated for chunked data)
async function performSearch() {
  const searchInput = document.getElementById("voterSearch");
  const searchTerm = searchInput?.value?.trim();

  if (!searchTerm || searchTerm.length < 1) {
    alert("рдХреГрдкрдпрд╛ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдХрдо рд╕реЗ рдХрдо 1 рдЕрдХреНрд╖рд░ рджрд░реНрдЬ рдХрд░реЗрдВ");
    return;
  }

  let results;
  if (voterChunkIndex) {
    // Use chunked search for full database
    results = await performChunkedSearch(searchTerm);
  } else {
    // Fallback to sample data search
    results = universalSearch(searchTerm);
  }

  displaySearchResults(results, searchTerm);
}

// Display search results
function displaySearchResults(results, searchTerm) {
  const resultsDiv = document.getElementById("searchResults");
  const noResultsDiv = document.getElementById("noResults");

  if (!resultsDiv) return;

  searchStats.lastSearchResults = results.length;

  if (results.length === 0) {
    resultsDiv.innerHTML = `
            <div class="no-results-container">
                <h3>ЁЯШФ рдХреЛрдИ рдкрд░рд┐рдгрд╛рдо рдирд╣реАрдВ рдорд┐рд▓рд╛</h3>
                <p>рдЦреЛрдЬ рд╢рдмреНрдж: <strong>"${searchTerm}"</strong></p>
                <div class="search-suggestions">
                    <h4>ЁЯТб рд╕реБрдЭрд╛рд╡:</h4>
                    <ul>
                        <li>тЬи рд╣рд┐рдВрджреА рдФрд░ English рджреЛрдиреЛрдВ рдореЗрдВ рдЦреЛрдЬреЗрдВ</li>
                        <li>ЁЯФН рдХрдо рдЕрдХреНрд╖рд░ рдЯрд╛рдЗрдк рдХрд░реЗрдВ</li>
                        <li>ЁЯУЭ рд╕реНрдкреЗрд▓рд┐рдВрдЧ рдЪреЗрдХ рдХрд░реЗрдВ</li>
                        <li>ЁЯЖФ рд╡реЛрдЯрд░ ID рд╕реЗ рдЦреЛрдЬреЗрдВ</li>
                    </ul>
                </div>
            </div>
        `;
    if (noResultsDiv) noResultsDiv.style.display = "none";
    return;
  }

  if (noResultsDiv) noResultsDiv.style.display = "none";

  // Add results header with count
  const resultsHeader = `
        <div class="search-results-header">
            <h3>ЁЯОп рд╕рд░реНрд╡реЛрддреНрддрдо ${results.length} рдкрд░рд┐рдгрд╛рдо</h3>
            <p class="search-info">рдЦреЛрдЬ рд╢рдмреНрдж: "<strong>${searchTerm}</strong>" рдХреЗ рд▓рд┐рдП рд╕рдмрд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдкрд░рд┐рдгрд╛рдо</p>
        </div>
    `;

  const resultsHTML =
    resultsHeader +
    results
      .map(
        (voter, index) => `
        <div class="voter-card enhanced-card" data-aos="fade-up" data-aos-delay="${
          index * 100
        }">
            <div class="voter-info">
                <h3>${voter.name} 
                    <span class="english-name">(${voter.name_en})</span></h3>
                <div class="voter-details">
                    <p><strong>ЁЯСитАНЁЯСж рдкрд┐рддрд╛ рдХрд╛ рдирд╛рдо:</strong> ${voter.father_name} 
                       <em>(${voter.father_name_en})</em></p>
                    <p><strong>ЁЯОВ рдЖрдпреБ:</strong> ${voter.age} рд╡рд░реНрд╖</p>
                    <p><strong>ЁЯЖФ рдорддрджрд╛рддрд╛ ID:</strong> <span class="voter-id">${
                      voter.voter_id
                    }</span></p>
                    <p><strong>ЁЯПа рдкрддрд╛:</strong> ${voter.address} 
                       <em>(${voter.address_en})</em></p>
                    <p><strong>ЁЯПЫя╕П рддрд╣рд╕реАрд▓:</strong> ${voter.tehsil} 
                       <em>(${voter.tehsil_en})</em></p>
                    <p><strong>ЁЯУо рдкреЛрд╕реНрдЯ рдСрдлрд┐рд╕:</strong> ${voter.post_office} 
                       <em>(${voter.post_office_en})</em></p>
                    <p><strong>ЁЯЧ│я╕П рдмреВрде рд╕рдВрдЦреНрдпрд╛:</strong> <span class="booth-number">${
                      voter.booth
                    }</span></p>
                    ${
                      voter.house_no
                        ? `<p><strong>ЁЯПб рдордХрд╛рди рдирдВрдмрд░:</strong> ${voter.house_no}</p>`
                        : ""
                    }
                </div>
            </div>
            <div class="voter-actions">
                <span class="verified-badge">тЬУ рд╕рддреНрдпрд╛рдкрд┐рдд</span>
                <span class="gender-badge ${
                  voter.gender === "M" ? "male" : "female"
                }">
                    ${voter.gender === "M" ? "ЁЯСи рдкреБрд░реБрд╖" : "ЁЯСй рдорд╣рд┐рд▓рд╛"}
                </span>
                <span class="constituency-badge">рд╡рд┐рдзрд╛рдирд╕рднрд╛ 29</span>
            </div>
        </div>
    `
      )
      .join("");

  resultsDiv.innerHTML = `
        <div class="results-header">
            <h3>ЁЯОп рдЦреЛрдЬ рдкрд░рд┐рдгрд╛рдо - рд░реБрдиреНрдиреАрд╕реИрджрдкреБрд░ рд╡рд┐рдзрд╛рдирд╕рднрд╛ рдХреНрд╖реЗрддреНрд░ 29</h3>
            <div class="search-info">
                <div class="results-count">${
                  results.length
                } рдорддрджрд╛рддрд╛ рдорд┐рд▓реЗ (рдХреБрд▓ ${searchStats.totalVoters.toLocaleString(
    "hi-IN"
  )} рдореЗрдВ рд╕реЗ)</div>
                <div class="search-term">рдЦреЛрдЬ: "<strong>${searchTerm}</strong>"</div>
            </div>
        </div>
        <div class="results-grid">
            ${resultsHTML}
        </div>
    `;
}

// Clear search results
function clearResults() {
  const resultsDiv = document.getElementById("searchResults");
  if (resultsDiv) {
    resultsDiv.innerHTML = "";
  }
}

// Test search functionality
function testSearch(term) {
  const searchInput = document.getElementById("voterSearch");
  if (searchInput) {
    searchInput.value = term;
    performSearch();
  }
}

// Polling Station Data and Analytics - Complete Dataset (171 stations)
const pollingStationData = [
  { station: "рд░рд╛рдЬрдХреАрдпрд╛ рдордзрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рд╕реАрд░рдЦрд┐рд░рд┐рдпрд╛, рд╕рд░рдЦрд┐рд░рд┐рдпрд╛", count: 4800 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдмрдШрд╛рдбрд╝реА", count: 4166 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рд░реВрдиреНрдиреАрд╕реИрджрдкреБрд░", count: 3986 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдУрд▓реАрдкреБрд░", count: 3637 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдмреЗрд▓рд╛рд╣реА рдирд┐рд▓рдХрдВрда", count: 3505 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЧрд╛рдврд╝рд╛", count: 3391 },
  {
    station:
      "рд░рд╛рдЬрдХреАрдпрд╛ рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рдзрд╛рд▓рдп рдХрдиреНрдпрд╛ рдкреНрд░реЗрдордирдЧрд░ рдЧреЛрдЯ рдХреЗ рдкреНрд░рд╛рдВрдЧрди рдореЗ рдЪрд▓рдВрдд рдорддрджрд╛рди",
    count: 3387,
  },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдереБрдореНрдорд╛-2", count: 3382 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдорд╣реЗрд╢рд╛-1", count: 3230 },
  { station: "рдмреБрдирд┐рдпрд╛рджреА рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЧреМрдбрд╝рд╛", count: 3224 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЯрд┐рдХреМрд▓реА", count: 3132 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдХрдиреНрдпрд╛ рдкреНрд░реЗрдордирдЧрд░ рдЧреЛрдЯ", count: 3035 },
  { station: "рдкрдВрдЪрд╛рдпрдд рднрд╡рди, рдмрдШрд╛рдбрд╝реА", count: 3013 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рдзрд╛рд▓рдп рдкреНрд░рдЦрдВрдб рдХреЙрд▓рдиреА", count: 2796 },
  { station: "рдЙрддреНрдХреНрд░рдорд┐рдд рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдмрд▓рд┐рдЧрдв", count: 2745 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рд░реВрдиреНрдиреА", count: 2683 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдореЗрд╣рд╕реМрд▓", count: 2660 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рдкрд╛рдардХ рдЯреЛрд▓рд╛ рдорд╛рдирд┐рдХ рдЪреМрдХ", count: 2636 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рдзрдиреБрд╖реА", count: 2628 },
  { station: "рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдореМрдирд╛ рдЙрд░реНрджреБ", count: 2616 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдореЛрд╣рдиреА", count: 2613 },
  { station: "рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рдорд╛рдирдкреБрд░ рд░рддреНрдирд╛рд╡рд▓реА", count: 2546 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рд▓рд╛рд▓рдкреБрд░ рдХреМрдбрд╝рд┐рдпрд╛", count: 2511 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЦрдбрд╝рдХрд╛", count: 2412 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдХреЛрджрд░рд┐рдпрд╛", count: 2338 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдорд╣рд┐рдиреНрджрд╡рд╛рд░рд╛", count: 2310 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рдЙрд░реНрджреВ рдЧреМрд╕рдирдЧрд░", count: 2252 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЧреИрдШрдЯ рдмрд╛рд▓рдХ", count: 2225 },
  { station: "рдЙрддреНрдХреНрд░рдорд┐рдд рдЙрдЪреНрдЪ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдмрд▓реБрдЖ", count: 2220 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╣рд┐рдиреНрджреА рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЧреМрд╕рдирдЧрд░", count: 2172 },
  { station: "рдЙрддреНрддрдХреНрд░рдорд┐рдд рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рд░рд╕рд▓рдкреБрд░ рдорд▓рдорд▓рд╛", count: 2164 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рдЦреЛрдкреА", count: 2114 },
  { station: "рдЙрддреНрдХреНрд░рдорд┐рдд рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдмрд╛рд╕рджреЗрд╡", count: 2102 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЧрд┐рджреНрдзрд╛", count: 2089 },
  {
    station: "рдореМрдЬреЗ рдХрд┐рд╢реЛрд░реА рдмрд╛рд▓рд┐рдХрд╛ рдЙрдЪреНрдЪрддрд░ рдорд╛рдзреНрдпрдорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп рдорд╛рдирд┐рдХ рдЪреМрдХ",
    count: 2085,
  },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рдХрдиреНрдпрд╛ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдереБрдореНрдорд╛", count: 2046 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдмрд░рд╣реЗрддрд╛ рдЙрд░реНрджреБ", count: 2034 },
  { station: "рдкрдВрдЪрд╛рдпрдд рднрд╡рди рдЯрд┐рдХреМрд▓реА рдЧрдВрдЧрд╡рд╛рд░рд╛", count: 2021 },
  { station: "рдорджрд░рд╕рд╛ рд░рд╕реАрджрд┐рдпрд╛, рд░рд╛рдпрдкреБрд░", count: 2018 },
  { station: "рдХрдиреНрдпрд╛ рдЙрдЪреНрдЪ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЕрдерд░реА", count: 2010 },
  { station: "рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп рд▓рд╛рд▓рдкреБрд░ рдХреМрдбрд╝рд┐рдпрд╛, рд▓рд╛рд▓рдкреБрд░", count: 2008 },
  { station: "рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп рдЬрди рд╢рд┐рдХреНрд╖рд╛ рдХреЗрдиреНрджреНрд░ рдзрдиреБрд╖реА", count: 1988 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдереБрдореНрдорд╛-1", count: 1981 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдкреБрдирд░рд╡рд╛рдбрд╝рд╛", count: 1959 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рдЕрдерд░реА рдмрд╛рд▓рдХ, рдЕрдерд░реА", count: 1958 },
  { station: "рдкрдВрдЪрд╛рдпрдд рднрд╡рди, рдЕрдерд░реА", count: 1951 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рддрд╛рд╣реАрд░рдкреБрд░", count: 1926 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рдорд╛рдирд┐рдХ рдЪреМрдХ", count: 1905 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдиреБрдиреМрд░рд╛", count: 1904 },
  { station: "рдкрдВрдЪрд╛рдпрдд рднрд╡рди, рд╕рд┐рд░рдЦрд┐рд░рд┐рдпрд╛", count: 1854 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдиреЗрдЙрд░реА", count: 1848 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рд░реВрджреМрд▓реА", count: 1840 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдореЗрджрдиреАрдкреБрд░", count: 1833 },
  { station: "рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдмрд▓рд┐рдЧрдв рд╣рд░рд┐рдЬрди", count: 1831 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдкреЛрддрд╛ рдЙрд░реНрдл рддрд┐рд▓рдХ рддрд╛рдЬрдкреБрд░ рдХрдиреНрдпрд╛", count: 1828 },
  { station: "рд╕рд╛рдореБрджрд╛рдпрд┐рдХ рднрд╡рди, рдорд╛рдирд┐рдХ рдЪреМрдХ", count: 1815 },
  { station: "рдХрдиреНрдпрд╛ рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рд╕рд╛рд╣ рдЯреЛрд▓рд╛ рдУрд▓реАрдкреБрд░", count: 1801 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЧреЛрд╡рд┐рдиреНрдж рдкрд┐рддреМрдЭрд┐рдпрд╛", count: 1795 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рд░реВрдкреМрд▓реА", count: 1786 },
  {
    station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп рдорд╛рдирд┐рдХ рдЪреМрдХ (рдЕрдиреБрд╕реВрдЪрд┐рдд рдЬрд╛рддрд┐ рдЯреЛрд▓рд╛)",
    count: 1764,
  },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдХреЛрд░рд▓рд╣рд┐рдпрд╛ рд╣рд░рд┐рдирд╛рд░рд╛рдпрдг", count: 1759 },
  { station: "рдЙрдЪреНрдЪ рд╡рд┐рджреНрдпрд╛рд▓рдп, рд░рд╛рдпрдкреБрд░", count: 1758 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдард╛рд╣рд░", count: 1728 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдордЭреМрд▓реА рдЙрд░реНрдл рднрдиреБрдбреАрд╣", count: 1691 },
  { station: "рдЙрддреНрдХреНрд░рдорд┐рдХ рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рджрд╕рдИ рдмрд╛рд▓рдХ", count: 1669 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рдорд╣рд┐рд╕рд╛рд░", count: 1660 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЦрд░рдкрдЯреГреА рдЧрдВрдЧрд╡рд╛рд░рд╛", count: 1656 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп рднрд░реЗрд╣рдмрд╛", count: 1636 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рд╣рд┐рд░рджреЛрдкрдЯреНрдЯреА", count: 1623 },
  { station: "рд╢рд╛рд░рджрд╛ рд╕рдВрд╕реНрдХреГрдд рд╡рд┐рджреНрдпрд╛рд▓рдп рдорд╛рдирд┐рдХ рдЪреМрдХ", count: 1619 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдкрдВрдбреМрд▓ рдЙрд░реНрджреВ", count: 1607 },
  { station: "рдЙрддреНрдХреНрд░рдорд┐рдд рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рд╕реБрд╣рдИрдЧрдврд╝", count: 1604 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рдмрд╛рд▓рдХ, рд░реИрди рд╡рд┐рд╢реБрдиреА", count: 1600 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдлреБрд▓рд╡рд░рд┐рдпрд╛", count: 1593 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНтАНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдкреЛрддрд╛ рдЙрд░реНрдл рддрд┐рд▓рдХрддрд╛рдЬрдкреБрд░", count: 1587 },
  { station: "рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп рд╢рд┐рд╡рдирдЧрд░ рдкреБрдирд░реНрд╡рд╛рд╕, рд╢рд┐рд╡рдирдЧрд░", count: 1583 },
  {
    station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдорд╛рдирд┐рдХ рдЪреМрдХ рдЯреЛрд▓реЗ рд╣рд░рд╕рд┐рдВрдЧрдкреБрд░",
    count: 1557,
  },
  { station: "рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рднреАрдордкреБрд░ рднрдкреБрд░рд╛", count: 1556 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдмрд╛рде рдЕрд╕рд▓реА", count: 1522 },
  { station: "рдкрдВрдЪрд╛рдпрдд рднрд╡рди, рдореЛрд░рд╕рдВрдб", count: 1506 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рд░рд╛рдпрдкреБрд░ рдХрдиреНрдпрд╛", count: 1506 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рддрд░рдорд╛", count: 1504 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рд╕рдХрд░реМрд▓реА", count: 1503 },
  { station: "рдорд╣рдВрде рд╡рд┐рдЬрдпрд╛рдирдВрдж рдЧрд┐рд░рд┐ рдЙрдЪреНрдЪ рд╡рд┐рджреНрдпрд╛рд▓рдп рдорд╛рдирд┐рдХ рдЪреМрдХ", count: 1496 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рдмрддрд░рд╛", count: 1486 },
  { station: "рдкрдВрдЪрд╛рдпрдд рднрд╡рди рдмрд╛рд░рд╛рдбреАрд╣", count: 1484 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНтАНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рд╕реБрдЧрд░реАрдбреАрд╣", count: 1473 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдзрдХрдЬрд░реА", count: 1456 },
  { station: "рдкрдВрдЪрд╛рдпрдд рднрд╡рди, рдЧреМрдбрд╝рд╛", count: 1437 },
  { station: "рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЦреЛрдкрд╛", count: 1433 },
  { station: "рдЙрддреНрдХреНрд░рдорд┐рдд рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдкреНрд░реЗрдордирдЧрд░", count: 1432 },
  { station: "рдЕрдиреБрд╕реВрдЪрд┐рдд рдЬрд╛рддрд┐ рджрд▓рд╛рди, рдЪрдорд╛рд░ рдЯреЛрд▓ рдмрд╛рде рдЕрд╕рд▓реА", count: 1420 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЯреЛрд▓реЗ рдЧреЛрд░реАрдЧрд╛рдорд╛", count: 1404 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рд░рд╛рдордирдЧрд░ рдмрдЧрд╛рд╣реА", count: 1403 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рд░рд╛рдордкреБрд░", count: 1398 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рд╡рд┐рд╢рдирдкреБрд░", count: 1393 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рд╕рдореМрд▓ рд╕рд╛рд╣рдкреБрд░", count: 1377 },
  { station: "рдЙрддреНрдХреНрд░рдорд┐рдд рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЗрдмреНрд░рд╛рд╣реАрдордкреБрд░", count: 1375 },
  {
    station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рдмрд╛рд▓рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдкреНрд░реЗрдордирдЧрд░ рдмрд╣реБрд░реА рдЯреЛрд▓рд╛",
    count: 1355,
  },
  { station: "рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдорд╛рдзреЛрдкреБрд░ рд╕реБрд▓рддрд╛рдирдкреБрд░", count: 1345 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рд╣рд╛рдЬреАрдкреБрд░ рдмрд╕рдВрдд", count: 1341 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рдмрдЧрд╛рд╣реА", count: 1326 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп (рдмрд╛рд▓рдХ), рдореЛрд░рд╕рдВрдб", count: 1323 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдорд╛рдзреЛрдкреБрд░ рд╕рд╛рд░рдирд╛рде рдмрд╛рд▓рдХ", count: 1308 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЪрдХрджреЛрдирдИ", count: 1303 },
  { station: "рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдХреЛрдЖрд╣реА", count: 1288 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЧрдВрдЧрд╡рд╛рд░рд╛", count: 1268 },
  { station: "рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдордзреМрд▓", count: 1266 },
  { station: "рдХреИрд▓рд╛рд╢рдкрддрд┐ рдЙрдЪреНрдЪ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЕрдерд░реА", count: 1245 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдмрдШреМрдиреА", count: 1243 },
  { station: "рдирд╡ рдирд┐рд░реНрдорд┐рдд рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдмреЗрд▓рд╣рд┐рдпрд╛", count: 1240 },
  { station: "рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп рдмреНрд░рд╣реНрдорд╕реНрдерд╛рди, рд╣рд░рд╕рд┐рдВрдЧрдкреБрд░", count: 1222 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рд╣рд░рджрд┐рдпрд╛", count: 1213 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рд░рд╛рдпрдкреБрд░", count: 1206 },
  { station: "рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдкреЛрдЦрд░рдкреБрд░", count: 1196 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЙрд░реНрджреВ рдореЗрд╣рд╕реМрд▓", count: 1191 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдмреБрд▓рдиреНрджрдкреБрд░ рдЙрд░реНрдлрд╝ рд╣реБрд╕реИрдирдкреБрд░", count: 1180 },
  { station: "рдордЦрдиреБ рдЙрдЪреНрдЪ рд╡рд┐рджреНрдпрд╛рд▓рдп, рддрд┐рд▓рдХ рддрд╛рдЬрдкреБрд░", count: 1173 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЪрдХрд╡рд╛", count: 1171 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп рдлреИрдЬрдкреБрд░ рдЙрд░реНрджреВ", count: 1161 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдмрд╕рддрдкреБрд░", count: 1151 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНтАНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рд╕реЛрдирдкреБрд░рд╡рд╛", count: 1148 },
  {
    station: "рдЕрдиреБрд╕реБрдЪрд┐рдд рдЬрд╛рддрд┐ рджрд▓рд╛рди, рдмрд╛рде рдЕрд╕рд▓реА рд░рд╛рдо рдЕрдзреАрди рдкрд╛рд╕рд╡рд╛рди рдХреЗ рдШрд░ рдХреЗ рдирд┐рдХрдЯ",
    count: 1146,
  },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рд░рд╛рдпрдкреБрд░", count: 1134 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЯреЛрд▓реЗ рднрд╛рд▓реЗ", count: 1133 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп рдордзреМрд▓ рдмрд╛рд▓рдХ", count: 1133 },
  { station: "рд░рд╛рдЬрдХреАрдп рдмреБрдирд┐рдпрд╛рджреА рд╡рд┐рджреНрдпрд╛рд▓рдп, рдордирдирдкреБрд░ рдореЛрд░рд╕рдВрдб", count: 1119 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рдмрд╛рд▓рдХ, рдХреБрдВрдбрд▓", count: 1099 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рдкреЛрддрд╛ рд░рдордирдЧрд░рд╛", count: 1092 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рдЙрд░реНрджреВ рд╡рд┐рджреНрдпрд╛рд▓рдп, рд░рдХрд╕рд┐рдпрд╛ рд░рд╛рдордкреБрд░", count: 1085 },
  { station: "рдкреБрд╕реНрддрдХрд╛рд▓рдп рднрд╡рди, рд░реИрди рд╡рд┐рд╢реБрдиреА", count: 1068 },
  { station: "рдордзреНрдп рд╡рд┐рдзрд╛рд▓рдп, рдмрд▓рд┐рдЧрдв", count: 1067 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЪреМрдкрд╛рд░ рдЦреБрд░реНрдж", count: 1061 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдмрд░рд╣реЗрддрд╛", count: 1047 },
  {
    station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдкреЛрддрд╛ рдЙрд░реНрдл рддрд┐рд▓рдХ рддрд╛рдЬрдкреБрд░ рдкреВрд░реНрд╡реА рдЯреЛрд▓рд╛",
    count: 1041,
  },
  { station: "рдирд╡рдпреБрд╡рдХ рдкреБрд╕реНрддрдХрд╛рд▓рдп, рдорд╛рдирд┐рдХ рдЪреМрдХ", count: 1005 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЪреМрдкрд╛рд░ рдХрд▓рд╛", count: 993 },
  { station: "рдЙрддреНрдХреНрд░рдорд┐рдд рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рд░реИрдирд╢рдВрдХрд░", count: 980 },
  { station: "рд╡реНрдпрд╛рдкрд╛рд░ рдордВрдбрд▓, рд░реВрдиреНрдиреАрд╕реИрджрдкреБрд░", count: 979 },
  { station: "рдЕрдиреБрд╕реВрдЪрд┐рдд рдЬрд╛рддрд┐ рдмреИрдардХрд╛ рдЪрдорд╛рд░ рдЯреЛрд▓ рд░рд╛рдпрдкреБрд░", count: 971 },
  {
    station: "рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдмреБрд▓рдВрджрдкреБрд░ рдЙрд░реНрдл рд╣реБрд╕реИрдирдкреБрд░ рдмрд▓рд╛рди рдЯреЛрд▓рд╛",
    count: 935,
  },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рднрдирд╕рдкрдЯреГреА", count: 926 },
  { station: "рдЙрддреНрдХреНрд░рдорд┐рдд рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдзрдирд╣рд░рд╛", count: 923 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдХреЛрдбрд▓рд╣рд┐рдпрд╛ рдХрдиреНрдпрд╛", count: 909 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдиреМрд╡рд╛рдбреАрд╣", count: 904 },
  { station: "рдЬрдирддрд╛ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдЧрд╛рдврд╛", count: 893 },
  { station: "рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп рд▓рдбрдХрдирд┐рдпрд╛ рдмрд╛рд╕рджреЗрд╡ рдЯреЛрд▓рд╛", count: 889 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЦрд░рд╣реБрдБрдЖ", count: 888 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЧрд░рдЧрдЯреНрдЯрд╛", count: 887 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдмреБрд▓рдиреНрджрдкреБрд░ рдЙрд░реНрдл рд╣реБрд╕реИрдирдкреБрд░", count: 886 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рднрдирд╕рдкрдЯрд░реНреА", count: 882 },
  { station: "рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рднрд╡рд╛рдиреАрдкреБрд░", count: 881 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдордзреМрд▓рдЧрдв", count: 871 },
  { station: "рд░рд╛рдЬрдХреАрдп рдХрдиреНрдпрд╛ рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдореЛрд░рд╕рдВрдб", count: 869 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдордЬрд░реЛрд╣рд╛", count: 863 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп рджрд┐рд▓рд╛рд╡рд░рдкреБрд░", count: 850 },
  { station: "рд░рд╛рдЬрдХреАрдп рдЙрддреНрдХреНрд░рдорд┐рдд рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдорд╣реЗрд╢рд╛", count: 832 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдмрдереБрд▓реА рдЙрд░реНрджреВ", count: 822 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рдЯрдХреМрд░", count: 772 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп, рдереБрдореНрдорд╛ рдЯреЛрд▓", count: 765 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рд╡рдпрдирд╛", count: 678 },
  { station: "рдЙрддреНрдХреНрд░рдорд┐рдд рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рд╕реБрдорд╣реМрддреА", count: 590 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рдЕрдирдиреНрдд рд╡рд┐рд╢рдирдкреБрд░", count: 588 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЪрдХрд╢рдВрднреБ", count: 577 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдмрддрд░реМрд▓реА", count: 569 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдорд╛рдзреЛрдкреБрд░ рдЪреМрдзрд░реА", count: 559 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рдзрд╛рд▓рдп рднрд░рдереА", count: 517 },
  { station: "рд░рд╛рдЬрдХреАрдп рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп рдХрдиреНрдпрд╛, рдХреБрдгреНрдбрд▓", count: 506 },
  { station: "рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп рд╣рдиреБрдорд╛рдирдирдЧрд░, рд╣рдиреБрдорд╛рдирдирдЧрд░", count: 484 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рд░рдХрд╕рд┐рдпрд╛", count: 432 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рдзреЛрдмрд╣рд╛", count: 409 },
  { station: "рд░рд╛рдЬрдХреАрдп рдордзреНрдп рд╡рд┐рджреНрдпрд╛рд▓рдп, рд╣рд╕рдирдкреБрд░", count: 328 },
];

// Initialize polling station analytics
function initPollingAnalytics() {
  if (
    typeof Plotly !== "undefined" &&
    document.getElementById("polling-chart")
  ) {
    showChart("bar");
  }
}

// Show different types of charts
function showChart(type) {
  const pollingChart = document.getElementById("polling-chart");
  const ageChart = document.getElementById("age-distribution-chart");
  if (!pollingChart || typeof Plotly === "undefined") return;

  // Update tab appearance
  document
    .querySelectorAll(".chart-tab")
    .forEach((tab) => tab.classList.remove("active"));
  document
    .querySelector(`[onclick="showChart('${type}')"]`)
    .classList.add("active");

  // Hide all charts
  pollingChart.style.display = "none";
  if (ageChart) ageChart.style.display = "none";

  switch (type) {
    case "bar":
      pollingChart.style.display = "block";
      showBarChart();
      break;
    case "pie":
      pollingChart.style.display = "block";
      showPieChart();
      break;
    case "age":
      if (ageChart) {
        ageChart.style.display = "block";
        showAgeDistributionChart();
      }
      break;
  }
}

// Bar Chart - All 171 polling stations with scrolling
function showBarChart() {
  const allStations = pollingStationData; // Show all 171 stations

  const trace = {
    x: allStations.map((d) => d.count),
    y: allStations.map((d) =>
      d.station.length > 50 ? d.station.substring(0, 50) + "..." : d.station
    ),
    type: "bar",
    orientation: "h",
    marker: {
      color: "rgba(255, 107, 53, 0.8)",
      line: {
        color: "rgba(255, 107, 53, 1.0)",
        width: 1,
      },
    },
    text: allStations.map((d) => d.count),
    textposition: "outside",
    textfont: {
      size: 11,
      color: "#2C3E50",
    },
  };

  const layout = {
    title: {
      text: "ЁЯУК рд╕рднреА 171 рдорддрджрд╛рди рдХреЗрдВрджреНрд░ (рдорддрджрд╛рддрд╛ рд╕рдВрдЦреНрдпрд╛ рдХреЗ рдЖрдзрд╛рд░ рдкрд░)",
      font: { size: 16, color: "#2C3E50", family: "Poppins" },
    },
    xaxis: {
      title: "рдорддрджрд╛рддрд╛рдУрдВ рдХреА рд╕рдВрдЦреНрдпрд╛",
      titlefont: { size: 14, color: "#2C3E50" },
    },
    yaxis: {
      title: "рдорддрджрд╛рди рдХреЗрдВрджреНрд░",
      titlefont: { size: 14, color: "#2C3E50" },
      tickfont: { size: 9 },
    },
    margin: { l: 400, r: 100, t: 80, b: 80 }, // Increased left margin for long names
    plot_bgcolor: "rgba(0,0,0,0)",
    paper_bgcolor: "rgba(0,0,0,0)",
    showlegend: false,
  };

  const config = {
    responsive: true,
    scrollZoom: true,
    displayModeBar: true,
    modeBarButtonsToAdd: ["pan2d", "zoom2d"],
  };

  Plotly.newPlot("polling-chart", [trace], layout, config);
}

// Pie Chart - Top 10 polling stations
function showPieChart() {
  const top10 = pollingStationData.slice(0, 10);
  const others = pollingStationData.slice(10);
  const othersSum = others.reduce((sum, d) => sum + d.count, 0);

  const labels = [
    ...top10.map((d) =>
      d.station.length > 30 ? d.station.substring(0, 30) + "..." : d.station
    ),
    "рдЕрдиреНрдп рдХреЗрдВрджреНрд░",
  ];
  const values = [...top10.map((d) => d.count), othersSum];

  const trace = {
    labels: labels,
    values: values,
    type: "pie",
    marker: {
      colors: [
        "#FF6B35",
        "#F7931E",
        "#FFE66D",
        "#27AE60",
        "#3498DB",
        "#9B59B6",
        "#E74C3C",
        "#95A5A6",
        "#F39C12",
        "#2ECC71",
        "#BDC3C7",
      ],
    },
    textinfo: "label+percent",
    textposition: "outside",
    textfont: {
      size: 11,
      color: "#2C3E50",
    },
  };

  const layout = {
    title: {
      text: "ЁЯез рд╢реАрд░реНрд╖ 10 рдорддрджрд╛рди рдХреЗрдВрджреНрд░ (рдкреНрд░рддрд┐рд╢рдд рд╡рд┐рддрд░рдг)",
      font: { size: 16, color: "#2C3E50", family: "Poppins" },
    },
    height: 600,
    margin: { l: 80, r: 80, t: 80, b: 80 },
    plot_bgcolor: "rgba(0,0,0,0)",
    paper_bgcolor: "rgba(0,0,0,0)",
    showlegend: false,
  };

  Plotly.newPlot("polling-chart", [trace], layout, { responsive: true });
}

// Age Distribution Chart - Interactive Histogram with 5-year bins
async function showAgeDistributionChart() {
  console.log("Creating age distribution chart...");

  // Collect age data from voter chunks or sample data
  let allAges = [];

  if (voterChunkIndex) {
    // Load all chunks and collect age data
    for (
      let i = 0;
      i < Math.min(10, voterChunkIndex.metadata.total_chunks);
      i++
    ) {
      // Limit to first 10 chunks for performance
      try {
        const chunkData = await loadChunk(i);
        const chunkAges = chunkData
          .filter((voter) => voter.a && voter.a > 0 && voter.a <= 120) // Valid ages only
          .map((voter) => voter.a);
        allAges.push(...chunkAges);
      } catch (error) {
        console.error(`Error loading chunk ${i} for age data:`, error);
      }
    }
  }

  // Fallback to sample data if no chunk data
  if (allAges.length === 0) {
    allAges = realVoterDataSample
      .filter((voter) => voter.age && voter.age > 0 && voter.age <= 120)
      .map((voter) => voter.age);
  }

  if (allAges.length === 0) {
    console.error("No age data available");
    return;
  }

  // Create 5-year age bins
  const minAge = Math.min(...allAges);
  const maxAge = Math.max(...allAges);
  const binSize = 5;
  const bins = [];
  const binLabels = [];
  const binCounts = [];

  // Create bins from minimum age to maximum age
  for (
    let age = Math.floor(minAge / binSize) * binSize;
    age <= maxAge;
    age += binSize
  ) {
    bins.push(age);
    binLabels.push(`${age}-${age + binSize - 1}`);

    // Count voters in this age range
    const count = allAges.filter((a) => a >= age && a < age + binSize).length;
    binCounts.push(count);
  }

  const trace = {
    x: binLabels,
    y: binCounts,
    type: "bar",
    marker: {
      color: "#4A90E2",
      line: {
        color: "#2C3E50",
        width: 1,
      },
    },
    hovertemplate:
      "<b>рдЖрдпреБ рд╕рдореВрд╣: %{x}</b><br>" +
      "рдорддрджрд╛рддрд╛ рд╕рдВрдЦреНрдпрд╛: %{y}<br>" +
      "<extra></extra>",
  };

  const layout = {
    title: {
      text: `ЁЯСе рдорддрджрд╛рддрд╛рдУрдВ рдХрд╛ рдЖрдпреБ рд╡рд┐рддрд░рдг (${allAges.length.toLocaleString(
        "hi-IN"
      )} рдирдореВрдирд╛)`,
      font: { size: 16, color: "#2C3E50", family: "Poppins" },
    },
    xaxis: {
      title: "рдЖрдпреБ рд╕рдореВрд╣ (рд╡рд░реНрд╖)",
      titlefont: { color: "#2C3E50", size: 14 },
      tickfont: { color: "#2C3E50", size: 12 },
      gridcolor: "#E5E5E5",
    },
    yaxis: {
      title: "рдорддрджрд╛рддрд╛рдУрдВ рдХреА рд╕рдВрдЦреНрдпрд╛",
      titlefont: { color: "#2C3E50", size: 14 },
      tickfont: { color: "#2C3E50", size: 12 },
      gridcolor: "#E5E5E5",
    },
    plot_bgcolor: "rgba(0,0,0,0)",
    paper_bgcolor: "rgba(0,0,0,0)",
    height: 500,
    margin: { l: 80, r: 40, t: 80, b: 80 },
    hovermode: "closest",
  };

  const config = {
    responsive: true,
    displayModeBar: true,
    modeBarButtonsToRemove: ["pan2d", "lasso2d", "select2d", "autoScale2d"],
    displaylogo: false,
  };

  Plotly.newPlot("age-distribution-chart", [trace], layout, config);

  console.log(`Age distribution chart created with ${allAges.length} records`);
  console.log(`Age range: ${minAge}-${maxAge} years, Bins: ${bins.length}`);
}

// Update DOMContentLoaded to include polling analytics
document.addEventListener("DOMContentLoaded", function () {
  console.log("DOM loaded, initializing voter search...");

  // Initialize AOS (Animate On Scroll)
  if (typeof AOS !== "undefined") {
    AOS.init({
      duration: 800,
      easing: "ease-in-out",
      once: true,
      offset: 100,
    });
  }

  initializeRealData();
  setupEventListeners();

  // Initialize polling analytics with a delay to ensure Plotly is loaded
  setTimeout(() => {
    initPollingAnalytics();
  }, 1000);

  // Initialize map zoom functionality
  initMapZoom();
});

// Map zoom functionality
let currentZoom = 1;
let isDragging = false;
let dragStart = { x: 0, y: 0 };
let imagePosition = { x: 0, y: 0 };

function initMapZoom() {
  const mapImg = document.getElementById("mapImage");
  const mapWrapper = document.getElementById("mapWrapper");

  if (!mapImg || !mapWrapper) return;

  // Mouse wheel zoom
  mapWrapper.addEventListener("wheel", function (e) {
    e.preventDefault();
    const delta = e.deltaY > 0 ? -0.1 : 0.1;
    const newZoom = Math.max(1, Math.min(3, currentZoom + delta));
    setZoom(newZoom);
  });

  // Touch pinch zoom
  let initialDistance = 0;
  let initialZoom = 1;

  mapWrapper.addEventListener("touchstart", function (e) {
    if (e.touches.length === 2) {
      initialDistance = getDistance(e.touches[0], e.touches[1]);
      initialZoom = currentZoom;
      e.preventDefault();
    } else if (e.touches.length === 1 && currentZoom > 1) {
      startDrag(e.touches[0]);
    }
  });

  mapWrapper.addEventListener("touchmove", function (e) {
    if (e.touches.length === 2) {
      e.preventDefault();
      const distance = getDistance(e.touches[0], e.touches[1]);
      const scale = distance / initialDistance;
      const newZoom = Math.max(1, Math.min(3, initialZoom * scale));
      setZoom(newZoom);
    } else if (e.touches.length === 1 && isDragging && currentZoom > 1) {
      drag(e.touches[0]);
      e.preventDefault();
    }
  });

  mapWrapper.addEventListener("touchend", function (e) {
    if (e.touches.length === 0) {
      stopDrag();
    }
  });

  // Mouse drag
  mapImg.addEventListener("mousedown", function (e) {
    if (currentZoom > 1) {
      startDrag(e);
      e.preventDefault();
    }
  });

  document.addEventListener("mousemove", function (e) {
    if (isDragging && currentZoom > 1) {
      drag(e);
    }
  });

  document.addEventListener("mouseup", stopDrag);
}

function zoomMap(direction, mapId = 1) {
  const currentZoomKey = `currentZoom${mapId}`;
  let currentZoom = window[currentZoomKey] || 1;

  let newZoom;
  if (direction === "in") {
    newZoom = Math.min(3, currentZoom + 0.5);
  } else if (direction === "out") {
    newZoom = Math.max(1, currentZoom - 0.5);
  }
  setZoom(newZoom, mapId);
}

function resetZoom(mapId = 1) {
  setZoom(1, mapId);
  const positionKey = `imagePosition${mapId}`;
  window[positionKey] = { x: 0, y: 0 };
  updateImageTransform(mapId);
}

function toggleZoom(mapId = 1) {
  const currentZoomKey = `currentZoom${mapId}`;
  const currentZoom = window[currentZoomKey] || 1;
  const newZoom = currentZoom === 1 ? 2 : 1;
  setZoom(newZoom, mapId);
  if (newZoom === 1) {
    const positionKey = `imagePosition${mapId}`;
    window[positionKey] = { x: 0, y: 0 };
    updateImageTransform(mapId);
  }
}

function setZoom(zoom, mapId = 1) {
  const currentZoomKey = `currentZoom${mapId}`;
  window[currentZoomKey] = zoom;
  const mapImg = document.getElementById(`mapImage${mapId}`);

  if (!mapImg) return; // Safety check

  if (zoom === 1) {
    mapImg.classList.remove("zoomed", "draggable");
    const positionKey = `imagePosition${mapId}`;
    window[positionKey] = { x: 0, y: 0 };
  } else {
    mapImg.classList.add("zoomed", "draggable");
  }

  updateImageTransform(mapId);
}

function updateImageTransform(mapId = 1) {
  const mapImg = document.getElementById(`mapImage${mapId}`);
  const currentZoomKey = `currentZoom${mapId}`;
  const positionKey = `imagePosition${mapId}`;
  const currentZoom = window[currentZoomKey] || 1;
  const imagePosition = window[positionKey] || { x: 0, y: 0 };

  if (mapImg) {
    mapImg.style.transform = `scale(${currentZoom}) translate(${imagePosition.x}px, ${imagePosition.y}px)`;
  }
}

function startDrag(pointer) {
  if (currentZoom > 1) {
    isDragging = true;
    dragStart.x = pointer.clientX - imagePosition.x;
    dragStart.y = pointer.clientY - imagePosition.y;

    const mapImg = document.getElementById("mapImage");
    const mapWrapper = document.getElementById("mapWrapper");
    mapImg.classList.add("dragging");
    mapWrapper.classList.add("dragging");
  }
}

function drag(pointer) {
  if (!isDragging) return;

  const mapWrapper = document.getElementById("mapWrapper");
  const rect = mapWrapper.getBoundingClientRect();
  const maxX = (rect.width * (currentZoom - 1)) / (2 * currentZoom);
  const maxY = (rect.height * (currentZoom - 1)) / (2 * currentZoom);

  let newX = pointer.clientX - dragStart.x;
  let newY = pointer.clientY - dragStart.y;

  // Constrain movement
  newX = Math.max(-maxX, Math.min(maxX, newX));
  newY = Math.max(-maxY, Math.min(maxY, newY));

  imagePosition.x = newX;
  imagePosition.y = newY;
  updateImageTransform();
}

function stopDrag() {
  isDragging = false;
  const mapImg = document.getElementById("mapImage");
  const mapWrapper = document.getElementById("mapWrapper");
  mapImg.classList.remove("dragging");
  mapWrapper.classList.remove("dragging");
}

function getDistance(touch1, touch2) {
  const dx = touch1.clientX - touch2.clientX;
  const dy = touch1.clientY - touch2.clientY;
  return Math.sqrt(dx * dx + dy * dy);
}
