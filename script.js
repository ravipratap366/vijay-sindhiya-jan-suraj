// Runnisaidpur Voter Data (Sample)

const realVoterDataSample = [
  {
    serial: 1,
    voter_id: "WHD2526531",
    name: "कृष्णा देवी",
    name_en: "Krishna Devi",
    father_name: "विजय महतो",
    father_name_en: "Vijay Mahto",
    age: 41,
    gender: "F",
    address: "गांव - प्रेमनगर सुहई",
    address_en: "Village - Premnagar Suhai",
    tehsil: "रुन्नीसैदपुर",
    tehsil_en: "Runnisaidpur",
    post_office: "प्रेमनगर सुहई",
    post_office_en: "Premnagar Suhai",
    booth: "001",
    house_no: "00",
  },
  {
    serial: 2,
    voter_id: "WHD2543502",
    name: "लंबू पासवान",
    name_en: "Lambu Paswan",
    father_name: "रामसागर पासवान",
    father_name_en: "Ramsagar Paswan",
    age: 30,
    gender: "M",
    address: "गांव - प्रेमनगर सुहई",
    address_en: "Village - Premnagar Suhai",
    tehsil: "रुन्नीसैदपुर",
    tehsil_en: "Runnisaidpur",
    post_office: "प्रेमनगर सुहई",
    post_office_en: "Premnagar Suhai",
    booth: "001",
    house_no: "00",
  },
  {
    serial: 3,
    voter_id: "WHD2519007",
    name: "बबिता देवी",
    name_en: "Babita Devi",
    father_name: "मनोज साह",
    father_name_en: "Manoj Sah",
    age: 29,
    gender: "F",
    address: "गांव - प्रेमनगर सुहई",
    address_en: "Village - Premnagar Suhai",
    tehsil: "रुन्नीसैदपुर",
    tehsil_en: "Runnisaidpur",
    post_office: "प्रेमनगर सुहई",
    post_office_en: "Premnagar Suhai",
    booth: "001",
    house_no: "00",
  },
  {
    serial: 4,
    voter_id: "WHD2524510",
    name: "चांदनी कुमारी",
    name_en: "Chandni Kumari",
    father_name: "सुबोध साह",
    father_name_en: "Subodh Sah",
    age: 27,
    gender: "F",
    address: "गांव - प्रेमनगर सुहई",
    address_en: "Village - Premnagar Suhai",
    tehsil: "रुन्नीसैदपुर",
    tehsil_en: "Runnisaidpur",
    post_office: "प्रेमनगर सुहई",
    post_office_en: "Premnagar Suhai",
    booth: "001",
    house_no: "00",
  },
  {
    serial: 5,
    voter_id: "WHD2543346",
    name: "रिंकी देवी",
    name_en: "Rinki Devi",
    father_name: "लंबू पासवान",
    father_name_en: "Lambu Paswan",
    age: 27,
    gender: "F",
    address: "गांव - प्रेमनगर सुहई",
    address_en: "Village - Premnagar Suhai",
    tehsil: "रुन्नीसैदपुर",
    tehsil_en: "Runnisaidpur",
    post_office: "प्रेमनगर सुहई",
    post_office_en: "Premnagar Suhai",
    booth: "001",
    house_no: "00",
  },
  {
    serial: 6,
    voter_id: "WHD2526895",
    name: "रंजय कुमार",
    name_en: "Ranjay Kumar",
    father_name: "नंद किशोर पासवान",
    father_name_en: "Nand Kishor Paswan",
    age: 23,
    gender: "M",
    address: "गांव - प्रेमनगर सुहई",
    address_en: "Village - Premnagar Suhai",
    tehsil: "रुन्नीसैदपुर",
    tehsil_en: "Runnisaidpur",
    post_office: "प्रेमनगर सुहई",
    post_office_en: "Premnagar Suhai",
    booth: "001",
    house_no: "00",
  },
  {
    serial: 7,
    voter_id: "WHD2518777",
    name: "शिवम कुमार",
    name_en: "Shivam Kumar",
    father_name: "भोला मंडल",
    father_name_en: "Bhola Mandal",
    age: 21,
    gender: "M",
    address: "गांव - प्रेमनगर सुहई",
    address_en: "Village - Premnagar Suhai",
    tehsil: "रुन्नीसैदपुर",
    tehsil_en: "Runnisaidpur",
    post_office: "प्रेमनगर सुहई",
    post_office_en: "Premnagar Suhai",
    booth: "001",
    house_no: "00",
  },
  {
    serial: 8,
    voter_id: "WHD1629005",
    name: "बबिता देवी",
    name_en: "Babita Devi",
    father_name: "बुधु मंडल",
    father_name_en: "Budhu Mandal",
    age: 36,
    gender: "F",
    address: "गांव - प्रेमनगर सुहई",
    address_en: "Village - Premnagar Suhai",
    tehsil: "रुन्नीसैदपुर",
    tehsil_en: "Runnisaidpur",
    post_office: "प्रेमनगर सुहई",
    post_office_en: "Premnagar Suhai",
    booth: "001",
    house_no: "3",
  },
  {
    serial: 9,
    voter_id: "WHD2451672",
    name: "सुनीला कुमारी",
    name_en: "Sunila Kumari",
    father_name: "पप्पू कुमार",
    father_name_en: "Pappu Kumar",
    age: 22,
    gender: "F",
    address: "गांव - प्रेमनगर सुहई",
    address_en: "Village - Premnagar Suhai",
    tehsil: "रुन्नीसैदपुर",
    tehsil_en: "Runnisaidpur",
    post_office: "प्रेमनगर सुहई",
    post_office_en: "Premnagar Suhai",
    booth: "001",
    house_no: "3",
  },
  {
    serial: 10,
    voter_id: "WHD0015495",
    name: "राजू साह",
    name_en: "Raju Sah",
    father_name: "सीताराम साह",
    father_name_en: "Sitaram Sah",
    age: 48,
    gender: "M",
    address: "गांव - प्रेमनगर सुहई",
    address_en: "Village - Premnagar Suhai",
    tehsil: "रुन्नीसैदपुर",
    tehsil_en: "Runnisaidpur",
    post_office: "प्रेमनगर सुहई",
    post_office_en: "Premnagar Suhai",
    booth: "001",
    house_no: "4",
  },
  {
    serial: 11,
    voter_id: "WHD3847592",
    name: "रवि प्रताप",
    name_en: "Ravi Pratap",
    father_name: "राम प्रकाश",
    father_name_en: "Ram Prakash",
    age: 32,
    gender: "M",
    address: "गांव - बघाड़ी",
    address_en: "Village - Baghadi",
    tehsil: "रुन्नीसैदपुर",
    tehsil_en: "Runnisaidpur",
    post_office: "बघाड़ी",
    post_office_en: "Baghadi",
    booth: "002",
    house_no: "15",
  },
  {
    serial: 12,
    voter_id: "WHD2847193",
    name: "प्रिया सिंह",
    name_en: "Priya Singh",
    father_name: "अजय सिंह",
    father_name_en: "Ajay Singh",
    age: 28,
    gender: "F",
    address: "गांव - मानिक चौक",
    address_en: "Village - Manik Chauk",
    tehsil: "रुन्नीसैदपुर",
    tehsil_en: "Runnisaidpur",
    post_office: "मानिक चौक",
    post_office_en: "Manik Chauk",
    booth: "005",
    house_no: "22",
  },
  {
    serial: 13,
    voter_id: "WHD2947583",
    name: "अनिल कुमार",
    name_en: "Anil Kumar",
    father_name: "लाल बहादुर",
    father_name_en: "Lal Bahadur",
    age: 35,
    gender: "M",
    address: "गांव - गौड़ा",
    address_en: "Village - Gauda",
    tehsil: "रुन्नीसैदपुर",
    tehsil_en: "Runnisaidpur",
    post_office: "गौड़ा",
    post_office_en: "Gauda",
    booth: "003",
    house_no: "08",
  },
  {
    serial: 14,
    voter_id: "WHD2637481",
    name: "सुमित्रा देवी",
    name_en: "Sumitra Devi",
    father_name: "गोपाल साह",
    father_name_en: "Gopal Sah",
    age: 45,
    gender: "F",
    address: "गांव - अथरी",
    address_en: "Village - Athari",
    tehsil: "रुन्नीसैदपुर",
    tehsil_en: "Runnisaidpur",
    post_office: "अथरी",
    post_office_en: "Athari",
    booth: "010",
    house_no: "12",
  },
  {
    serial: 15,
    voter_id: "WHD2745629",
    name: "राहुल मिश्रा",
    name_en: "Rahul Mishra",
    father_name: "विनोद मिश्रा",
    father_name_en: "Vinod Mishra",
    age: 26,
    gender: "M",
    address: "गांव - रायपुर",
    address_en: "Village - Raipur",
    tehsil: "रुन्नीसैदपुर",
    tehsil_en: "Runnisaidpur",
    post_office: "रायपुर",
    post_office_en: "Raipur",
    booth: "015",
    house_no: "05",
  },
  {
    serial: 16,
    voter_id: "WHD2139061",
    name: "रवि प्रताप",
    name_en: "Ravi Pratap",
    father_name: "विजय कुमार साह",
    father_name_en: "Vijay Kumar Sah",
    age: 26,
    gender: "M",
    address: "रुन्नीसैदपुर",
    address_en: "Runnisaidpur",
    tehsil: "रुन्नीसैदपुर",
    tehsil_en: "Runnisaidpur",
    post_office: "रून्नीसैदपुर",
    post_office_en: "Runnisaidpur",
    booth: "270",
    house_no: "रुनीसैदपुर",
  },
];

// Global variables for chunked data system
let voterChunkIndex = null;
let loadedChunks = new Map();
let voterData = []; // Fallback to sample data
let searchStats = {
  totalVoters: 277703, // Updated from actual database
  lastSearchResults: 0,
  totalMale: 147941, // Real official male count
  totalFemale: 129666, // Real official female count
};

// Initialize chunked data system
async function initializeChunkedData() {
  try {
    console.log("Loading voter chunk index...");
    const response = await fetch("voter-chunks/index.json");

    if (!response.ok) {
      console.log("Chunk index not found, using sample data");
      return false;
    }

    voterChunkIndex = await response.json();
    console.log(
      `Loaded chunk index: ${voterChunkIndex.metadata.total_chunks} chunks, ${voterChunkIndex.metadata.total_records} total records`
    );

    // Update UI with actual statistics
    const totalVotersEl = document.getElementById("totalVoters");
    if (totalVotersEl) {
      totalVotersEl.textContent =
        voterChunkIndex.metadata.total_records.toLocaleString("hi-IN");
    }

    return true;
  } catch (error) {
    console.error("Error loading chunk index:", error);
    return false;
  }
}

// Load a specific chunk
async function loadChunk(chunkId) {
  if (loadedChunks.has(chunkId)) {
    return loadedChunks.get(chunkId);
  }

  try {
    const response = await fetch(
      `voter-chunks/chunk-${chunkId.toString().padStart(3, "0")}.json`
    );
    if (!response.ok) {
      throw new Error(`Chunk ${chunkId} not found`);
    }

    const chunkData = await response.json();
    loadedChunks.set(chunkId, chunkData.voters);
    console.log(`Loaded chunk ${chunkId}: ${chunkData.voters.length} records`);

    return chunkData.voters;
  } catch (error) {
    console.error(`Error loading chunk ${chunkId}:`, error);
    return [];
  }
}

// Chunked search function
async function performChunkedSearch(searchTerm) {
  if (!voterChunkIndex) {
    // Fallback to sample data
    return universalSearch(searchTerm);
  }

  const rankedResults = [];
  const normalizedTerm = searchTerm.toLowerCase().trim().replace(/\s+/g, " ");
  const MAX_RESULTS = 15; // Show top 15 best matches
  const MIN_SCORE_THRESHOLD = 15; // Minimum relevance score to include

  // Show loading indicator
  const resultsDiv = document.getElementById("searchResults");
  if (resultsDiv) {
    resultsDiv.innerHTML =
      '<div class="loading">🔍 खोज रहे हैं... कृपया प्रतीक्षा करें</div>';
  }

  try {
    let chunksProcessed = 0;
    let exactMatches = [];
    let goodMatches = [];
    let partialMatches = [];

    // Search through chunks efficiently with progressive filtering
    for (let i = 0; i < voterChunkIndex.metadata.total_chunks; i++) {
      const chunkData = await loadChunk(i);

      if (!chunkData || chunkData.length === 0) {
        continue;
      }

      // Search within this chunk with ranking
      for (const voter of chunkData) {
        if (!voter || !voter.n) continue; // Skip invalid records

        const relevance = calculateRelevanceScore(voter, normalizedTerm);

        if (relevance >= MIN_SCORE_THRESHOLD) {
          const result = { voter, relevance };

          // Categorize results for better sorting
          if (relevance >= 90) {
            exactMatches.push(result);
          } else if (relevance >= 60) {
            goodMatches.push(result);
          } else {
            partialMatches.push(result);
          }
        }
      }

      chunksProcessed++;

      // Show progress for large searches
      if (chunksProcessed % 3 === 0) {
        const progress = Math.round(
          (chunksProcessed / voterChunkIndex.metadata.total_chunks) * 100
        );
        if (resultsDiv) {
          resultsDiv.innerHTML = `<div class="loading">🔍 खोज रहे हैं... ${progress}% पूर्ण (${
            exactMatches.length + goodMatches.length + partialMatches.length
          } मिले)</div>`;
        }
      }

      // Early termination conditions
      const totalFound =
        exactMatches.length + goodMatches.length + partialMatches.length;

      // If we have enough exact matches, stop searching
      if (exactMatches.length >= MAX_RESULTS) {
        console.log(
          `Found ${exactMatches.length} exact matches, stopping search early`
        );
        break;
      }

      // If we have a good number of high-quality results and processed significant chunks
      if (
        totalFound >= MAX_RESULTS * 2 &&
        chunksProcessed >=
          Math.min(20, voterChunkIndex.metadata.total_chunks * 0.4)
      ) {
        console.log(
          `Found ${totalFound} results after processing ${chunksProcessed} chunks, stopping search`
        );
        break;
      }
    }

    // Combine results with priority: exact matches first, then good matches, then partial
    rankedResults.push(...exactMatches, ...goodMatches, ...partialMatches);

    // Sort by relevance and take top results only
    rankedResults.sort((a, b) => b.relevance - a.relevance);
    const topResults = rankedResults.slice(0, MAX_RESULTS);

    return topResults.map((result) => ({
      // Convert optimized format back to full format
      serial: result.voter.i || 0,
      voter_id: result.voter.v || "",
      name: result.voter.n || "",
      name_en: result.voter.n || "",
      father_name: result.voter.g || "",
      father_name_en: result.voter.g || "",
      age: result.voter.a || 0,
      gender: result.voter.s || "",
      address: result.voter.po || result.voter.p || "",
      address_en: result.voter.po || result.voter.p || "",
      tehsil: result.voter.t || "रुन्नीसैदपुर",
      tehsil_en: result.voter.t || "Runnisaidpur",
      post_office: result.voter.po || "",
      post_office_en: result.voter.po || "",
      booth: result.voter.pn ? result.voter.pn.toString() : "",
      house_no: result.voter.h || "",
      relevance: result.relevance, // Keep for debugging
    }));
  } catch (error) {
    console.error("Error in chunked search:", error);
    return universalSearch(searchTerm); // Fallback to sample data
  }
}

// Enhanced relevance score calculation for comprehensive search
function calculateRelevanceScore(voter, searchTerm) {
  let score = 0;
  const term = searchTerm.toLowerCase().trim();
  const searchWords = term.split(" ").filter((word) => word.length > 0);

  // Get voter fields with null safety
  const name = (voter.n || "").toLowerCase().trim();
  const guardian = (voter.g || "").toLowerCase().trim();
  const voterId = (voter.v || "").toLowerCase().trim();
  const address = (voter.po || voter.p || "").toLowerCase().trim();
  const houseNo = (voter.h || "").toLowerCase().trim();
  const age = voter.a ? voter.a.toString() : "";
  const tehsil = (voter.t || "").toLowerCase().trim();

  // Exact name match (highest priority)
  if (name === term) {
    score += 100;
  }
  // Name starts with search term
  else if (name.startsWith(term)) {
    score += 90;
  }
  // Name contains search term
  else if (name.includes(term)) {
    score += 70;
  }
  // All search words found in name (any order)
  else if (
    searchWords.length > 1 &&
    searchWords.every((word) => name.includes(word))
  ) {
    score += 65;
  }
  // Partial name matches (surname, middle name, etc.)
  else {
    let partialMatches = 0;
    searchWords.forEach((word) => {
      if (word.length >= 2 && name.includes(word)) {
        partialMatches++;
        score += 20;
      }
    });
    // Bonus for multiple partial matches
    if (partialMatches > 1) {
      score += 15;
    }
  }

  // Exact voter ID match (very high priority)
  if (voterId === term) {
    score += 95;
  }
  // Voter ID contains search term
  else if (voterId.includes(term)) {
    score += 80;
  }

  // Guardian name matches
  if (guardian) {
    if (guardian.includes(term)) {
      score += 45;
    } else {
      // Check individual words in guardian name
      searchWords.forEach((word) => {
        if (word.length >= 3 && guardian.includes(word)) {
          score += 25;
        }
      });
    }
  }

  // House number matches
  if (houseNo && (houseNo === term || houseNo.includes(term))) {
    score += 50;
  }

  // Address matches
  if (address.includes(term)) {
    score += 35;
  }

  // Age match (if numeric search)
  if (age && age === term) {
    score += 40;
  }

  // Tehsil match
  if (tehsil.includes(term)) {
    score += 25;
  }

  // Cross-language and phonetic matching
  if (crossLanguageMatch(term, name) || crossLanguageMatch(term, guardian)) {
    score += 30;
  }

  // Fuzzy matching for common typos (basic implementation)
  if (term.length >= 4) {
    searchWords.forEach((word) => {
      if (word.length >= 4) {
        // Check for single character differences
        if (levenshteinDistance(word, name) <= 1) {
          score += 20;
        }
      }
    });
  }

  return Math.min(score, 100); // Cap at 100
}

// Simple Levenshtein distance for fuzzy matching
function levenshteinDistance(str1, str2) {
  const matrix = [];

  if (str1.length === 0) return str2.length;
  if (str2.length === 0) return str1.length;

  for (let i = 0; i <= str2.length; i++) {
    matrix[i] = [i];
  }

  for (let j = 0; j <= str1.length; j++) {
    matrix[0][j] = j;
  }

  for (let i = 1; i <= str2.length; i++) {
    for (let j = 1; j <= str1.length; j++) {
      if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
        matrix[i][j] = matrix[i - 1][j - 1];
      } else {
        matrix[i][j] = Math.min(
          matrix[i - 1][j - 1] + 1,
          matrix[i][j - 1] + 1,
          matrix[i - 1][j] + 1
        );
      }
    }
  }

  return matrix[str2.length][str1.length];
}

// Search within a single voter record (optimized format)
function searchInVoterRecord(voter, searchTerm) {
  const searchFields = [
    voter.n, // name
    voter.g, // guardian name
    voter.v, // voter_id
    voter.po, // post office
    voter.p, // polling station
    voter.t, // tehsil
    voter.h, // house number
    voter.a?.toString(), // age
  ];

  const searchWords = searchTerm.split(" ").filter((word) => word.length > 0);

  return searchFields.some((field) => {
    if (!field) return false;
    const fieldLower = field
      .toString()
      .toLowerCase()
      .trim()
      .replace(/\s+/g, " ");

    // Direct match
    if (fieldLower.includes(searchTerm)) return true;

    // Word-by-word matching
    if (searchWords.every((word) => fieldLower.includes(word))) return true;

    // Cross-language matching
    if (crossLanguageMatch(searchTerm, fieldLower)) return true;

    // Flexible spacing
    const termNoSpaces = searchTerm.replace(/\s+/g, "");
    const fieldNoSpaces = fieldLower.replace(/\s+/g, "");
    if (fieldNoSpaces.includes(termNoSpaces) && termNoSpaces.length > 2)
      return true;

    return false;
  });
}

// Initialize the application
document.addEventListener("DOMContentLoaded", function () {
  console.log("DOM loaded, initializing voter search...");

  // Initialize AOS (Animate On Scroll) with mobile-optimized settings
  if (typeof AOS !== "undefined") {
    AOS.init({
      duration: 600,
      easing: "ease-in-out",
      once: true,
      offset: 50, // Reduced offset for mobile
      disable: function () {
        return window.innerWidth < 480; // Disable on very small screens
      },
    });
  }

  // Mobile-specific optimizations
  initializeMobileOptimizations();

  // Initialize data systems
  initializeRealData();
  setupEventListeners();

  // Initialize chunked data system
  initializeChunkedData();
});

// Mobile optimizations
function initializeMobileOptimizations() {
  // Prevent zoom on input focus for iOS
  if (navigator.userAgent.match(/iPhone|iPad|iPod/i)) {
    const inputs = document.querySelectorAll(
      'input[type="text"], input[type="search"], textarea'
    );
    inputs.forEach((input) => {
      input.addEventListener("focus", function () {
        this.style.fontSize = "16px";
      });
    });
  }

  // Improve touch scrolling for mobile
  if ("ontouchstart" in window) {
    document.body.style.webkitOverflowScrolling = "touch";
  }

  // Close mobile menu when clicking outside
  document.addEventListener("click", function (event) {
    const navMenu = document.querySelector(".nav-menu");
    const hamburger = document.querySelector(".hamburger");

    if (
      navMenu &&
      hamburger &&
      !navMenu.contains(event.target) &&
      !hamburger.contains(event.target) &&
      navMenu.classList.contains("active")
    ) {
      navMenu.classList.remove("active");
      hamburger.classList.remove("active");
    }
  });

  // Auto-close mobile menu when link is clicked
  const navLinks = document.querySelectorAll(".nav-menu a");
  navLinks.forEach((link) => {
    link.addEventListener("click", function () {
      const navMenu = document.querySelector(".nav-menu");
      const hamburger = document.querySelector(".hamburger");

      if (navMenu && hamburger) {
        navMenu.classList.remove("active");
        hamburger.classList.remove("active");
      }
    });
  });
}

// Initialize with real voter data
function initializeRealData() {
  voterData = realVoterDataSample;
  updateRealVoterStats();
  displayRealDataInfo();
  console.log(
    "Real voter data loaded: 15 sample records from 279,729 total voters"
  );
}

// Update statistics with real data
function updateRealVoterStats() {
  // Update UI with official statistics
  const totalVotersEl = document.getElementById("totalVoters");
  const maleVotersEl = document.getElementById("maleVoters");
  const femaleVotersEl = document.getElementById("femaleVoters");

  if (totalVotersEl) totalVotersEl.textContent = "2,79,729";
  if (maleVotersEl) maleVotersEl.textContent = "1,47,941";
  if (femaleVotersEl) femaleVotersEl.textContent = "1,29,666";
}

// Display data information
function displayRealDataInfo() {
  const noteHTML = `
        <div class="simple-note" data-aos="fade-up">
            <div class="note-card">
                <div class="note-icon">📊</div>
                <div class="note-content">
                    <h4>आधिकारिक मतदाता डेटाबेस</h4>
                    <p><strong>स्रोत:</strong> भारतीय निर्वाचन आयोग 2025 - रुन्नीसैदपुर विधानसभा क्षेत्र 29</p>
                    <p><strong>कुल मतदाता:</strong> 2,79,729 (पुरुष: 1,47,941 | महिला: 1,29,666)</p>
                    <p><strong>वर्तमान स्थिति:</strong> पूर्ण डेटाबेस - 2,77,703 वास्तविक मतदाता रिकॉर्ड</p>
                </div>
            </div>
        </div>
    `;

  // Replace any existing data note
  const existingNote = document.querySelector(
    ".simple-note, .data-note, .data-info-section"
  );
  if (existingNote && existingNote.parentNode) {
    existingNote.parentNode.innerHTML = noteHTML;
  }
}

// Enhanced universal search with ranking
// function universalSearch(searchTerm) {
//   if (!searchTerm || searchTerm.trim().length === 0) return [];

//   // Normalize search term - remove extra spaces, convert to lowercase
//   const term = searchTerm.toLowerCase().trim().replace(/\s+/g, " ");
//   const MAX_RESULTS = 12; // Consistent with chunked search

//   // Calculate relevance scores for sample data
//   const rankedResults = voterData
//     .map((voter) => {
//       const relevance = calculateSampleDataRelevance(voter, term);
//       return { voter, relevance };
//     })
//     .filter((result) => result.relevance > 0);

//   // Sort by relevance and return top results
//   rankedResults.sort((a, b) => b.relevance - a.relevance);
//   return rankedResults.slice(0, MAX_RESULTS).map((result) => result.voter);
// }
async function universalSearch(searchTerm) {
  if (!searchTerm || searchTerm.trim().length === 0) return [];

  const term = searchTerm.toLowerCase().trim().replace(/\s+/g, " ");
  const MAX_RESULTS = 12;

  // Remote results
  let remoteResults = [];
  try {
    const url = `https://script.google.com/macros/s/AKfycbxeTD2UsL-rVtkp07IZ0GRf-_eurftOG9JGhTx--B05fiF3Mp9DypZiNVhK2FWbolDLXw/exec?q=${encodeURIComponent(
      searchTerm
    )}`;

    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const data = await res.json();

    if (Array.isArray(data)) {
      remoteResults = data.map((voter) => ({
        voter,
        relevance: calculateSampleDataRelevance(voter, term) || 1, // fallback relevance
      }));
    }
  } catch (err) {
    console.error("Remote fetch failed:", err.message);
  }

  // Sort & return top MAX_RESULTS
  remoteResults.sort((a, b) => b.relevance - a.relevance);
  return allResults.slice(0, MAX_RESULTS).map((r) => r.voter);
}

// Calculate relevance score for sample data format
function calculateSampleDataRelevance(voter, searchTerm) {
  let score = 0;
  const term = searchTerm.toLowerCase();
  const searchWords = term.split(" ").filter((word) => word.length > 0);

  // Get voter fields
  const name = (voter.name || "").toLowerCase();
  const nameEn = (voter.name_en || "").toLowerCase();
  const fatherName = (voter.father_name || "").toLowerCase();
  const voterId = (voter.voter_id || "").toLowerCase();
  const address = (voter.address || "").toLowerCase();
  const houseNo = (voter.house_no || "").toLowerCase();

  // Exact name match (highest priority)
  if (name === term || nameEn === term) {
    score += 100;
  }
  // Name starts with search term
  else if (name.startsWith(term) || nameEn.startsWith(term)) {
    score += 90;
  }
  // Name contains search term
  else if (name.includes(term) || nameEn.includes(term)) {
    score += 70;
  }
  // All search words found in name
  else if (
    searchWords.every((word) => name.includes(word) || nameEn.includes(word))
  ) {
    score += 60;
  }

  // Exact voter ID match
  if (voterId === term || voterId.includes(term)) {
    score += 85;
  }

  // Father name matches
  if (fatherName.includes(term)) {
    score += 40;
  }

  // House number exact match
  if (houseNo && houseNo === term) {
    score += 50;
  }

  // Address matches
  if (address.includes(term)) {
    score += 30;
  }

  // Cross-language matching
  if (crossLanguageMatch(term, name) || crossLanguageMatch(term, nameEn)) {
    score += 35;
  }

  // Partial word matches in name (at least 3 characters)
  if (term.length >= 3) {
    searchWords.forEach((word) => {
      if (word.length >= 3 && (name.includes(word) || nameEn.includes(word))) {
        score += 25;
      }
    });
  }

  return Math.min(score, 100); // Cap at 100
}

// Enhanced cross-language matching function
function crossLanguageMatch(searchTerm, fieldValue) {
  // Common Hindi-English name mappings
  const nameTranslations = {
    // Names
    ravi: ["रवि", "रावी"],
    रवि: ["ravi"],
    pratap: ["प्रताप", "प्रताप"],
    प्रताप: ["pratap"],
    ram: ["राम"],
    राम: ["ram"],
    prakash: ["प्रकाश"],
    प्रकाश: ["prakash"],
    krishna: ["कृष्णा", "कृष्ण"],
    कृष्णा: ["krishna"],
    कृष्ण: ["krishna"],
    devi: ["देवी"],
    देवी: ["devi"],
    kumar: ["कुमार"],
    कुमार: ["kumar"],
    singh: ["सिंह"],
    सिंह: ["singh"],
    sah: ["साह"],
    साह: ["sah"],
    mandal: ["मंडल"],
    मंडल: ["mandal"],
    paswan: ["पासवान"],
    पासवान: ["paswan"],
    mishra: ["मिश्रा"],
    मिश्रा: ["mishra"],

    // Places
    baghadi: ["बघाड़ी"],
    बघाड़ी: ["baghadi"],
    runnisaidpur: ["रुन्नीसैदपुर"],
    रुन्नीसैदपुर: ["runnisaidpur"],
    premnagar: ["प्रेमनगर"],
    प्रेमनगर: ["premnagar"],
    gauda: ["गौड़ा"],
    गौड़ा: ["gauda"],
    athari: ["अथरी"],
    अथरी: ["athari"],
    raipur: ["रायपुर"],
    रायपुर: ["raipur"],
    manik: ["मानिक"],
    मानिक: ["manik"],
    chauk: ["चौक"],
    चौक: ["chauk"],

    // Common words
    village: ["गांव", "ग्राम"],
    गांव: ["village"],
    ग्राम: ["village"],
  };

  // Normalize both search term and field value
  const normalizedSearch = searchTerm.toLowerCase().trim().replace(/\s+/g, " ");
  const normalizedField = fieldValue.toLowerCase().trim().replace(/\s+/g, " ");

  const searchWords = normalizedSearch
    .split(" ")
    .filter((word) => word.length > 0);

  for (const word of searchWords) {
    const translations = nameTranslations[word];
    if (translations) {
      for (const translation of translations) {
        const normalizedTranslation = translation.toLowerCase().trim();
        // Check both with spaces and without spaces
        if (
          normalizedField.includes(normalizedTranslation) ||
          normalizedField
            .replace(/\s+/g, "")
            .includes(normalizedTranslation.replace(/\s+/g, ""))
        ) {
          return true;
        }
      }
    }
  }

  return false;
}

// Setup event listeners
function setupEventListeners() {
  const searchBtn = document.getElementById("searchBtn");
  const searchInput = document.getElementById("voterSearch");

  console.log("Setting up event listeners...");
  console.log("Search button found:", !!searchBtn);
  console.log("Search input found:", !!searchInput);

  if (searchBtn) {
    searchBtn.addEventListener("click", function () {
      console.log("Search button clicked");
      performSearch();
    });
  } else {
    console.error("Search button not found!");
  }

  if (searchInput) {
    searchInput.addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
        console.log("Enter key pressed");
        performSearch();
      }
    });

    // Real-time search
    searchInput.addEventListener("input", function (e) {
      if (e.target.value.length >= 2) {
        console.log("Input search triggered:", e.target.value);
        performSearch();
      } else if (e.target.value.length === 0) {
        clearResults();
      }
    });
  } else {
    console.error("Search input not found!");
  }
}

// Perform search (updated for chunked data)
async function performSearch() {
  const searchInput = document.getElementById("voterSearch");
  const searchTerm = searchInput?.value?.trim();

  if (!searchTerm || searchTerm.length < 1) {
    alert("कृपया खोजने के लिए कम से कम 1 अक्षर दर्ज करें");
    return;
  }

  let results;
  if (voterChunkIndex) {
    // Use chunked search for full database
    results = await performChunkedSearch(searchTerm);
  } else {
    // Fallback to sample data search
    results = universalSearch(searchTerm);
  }

  displaySearchResults(results, searchTerm);
}

// Display search results
function displaySearchResults(results, searchTerm) {
  const resultsDiv = document.getElementById("searchResults");
  const noResultsDiv = document.getElementById("noResults");

  if (!resultsDiv) return;

  searchStats.lastSearchResults = results.length;

  if (results.length === 0) {
    resultsDiv.innerHTML = `
            <div class="no-results-container">
                <h3>😔 कोई परिणाम नहीं मिला</h3>
                <p>खोज शब्द: <strong>"${searchTerm}"</strong></p>
                <div class="search-suggestions">
                    <h4>💡 सुझाव:</h4>
                    <ul>
                        <li>✨ हिंदी और English दोनों में खोजें</li>
                        <li>🔍 कम अक्षर टाइप करें</li>
                        <li>📝 स्पेलिंग चेक करें</li>
                        <li>🆔 वोटर ID से खोजें</li>
                    </ul>
                </div>
            </div>
        `;
    if (noResultsDiv) noResultsDiv.style.display = "none";
    return;
  }

  if (noResultsDiv) noResultsDiv.style.display = "none";

  // Add results header with count
  const resultsHeader = `
        <div class="search-results-header">
            <h3>🎯 सर्वोत्तम ${results.length} परिणाम</h3>
            <p class="search-info">खोज शब्द: "<strong>${searchTerm}</strong>" के लिए सबसे संबंधित परिणाम</p>
        </div>
    `;

  const resultsHTML =
    resultsHeader +
    results
      .map(
        (voter, index) => `
        <div class="voter-card enhanced-card" data-aos="fade-up" data-aos-delay="${
          index * 100
        }">
            <div class="voter-info">
                <h3>${voter.name} 
                    <span class="english-name">(${voter.name_en})</span></h3>
                <div class="voter-details">
                    <p><strong>👨‍👦 पिता का नाम:</strong> ${voter.father_name} 
                       <em>(${voter.father_name_en})</em></p>
                    <p><strong>🎂 आयु:</strong> ${voter.age} वर्ष</p>
                    <p><strong>🆔 मतदाता ID:</strong> <span class="voter-id">${
                      voter.voter_id
                    }</span></p>
                    <p><strong>🏠 पता:</strong> ${voter.address} 
                       <em>(${voter.address_en})</em></p>
                    <p><strong>🏛️ तहसील:</strong> ${voter.tehsil} 
                       <em>(${voter.tehsil_en})</em></p>
                    <p><strong>📮 पोस्ट ऑफिस:</strong> ${voter.post_office} 
                       <em>(${voter.post_office_en})</em></p>
                    <p><strong>🗳️ बूथ संख्या:</strong> <span class="booth-number">${
                      voter.booth
                    }</span></p>
                    ${
                      voter.house_no
                        ? `<p><strong>🏡 मकान नंबर:</strong> ${voter.house_no}</p>`
                        : ""
                    }
                </div>
            </div>
            <div class="voter-actions">
                <span class="verified-badge">✓ सत्यापित</span>
                <span class="gender-badge ${
                  voter.gender === "M" ? "male" : "female"
                }">
                    ${voter.gender === "M" ? "👨 पुरुष" : "👩 महिला"}
                </span>
                <span class="constituency-badge">विधानसभा 29</span>
            </div>
        </div>
    `
      )
      .join("");

  resultsDiv.innerHTML = `
        <div class="results-header">
            <h3>🎯 खोज परिणाम - रुन्नीसैदपुर विधानसभा क्षेत्र 29</h3>
            <div class="search-info">
                <div class="results-count">${
                  results.length
                } मतदाता मिले (कुल ${searchStats.totalVoters.toLocaleString(
    "hi-IN"
  )} में से)</div>
                <div class="search-term">खोज: "<strong>${searchTerm}</strong>"</div>
            </div>
        </div>
        <div class="results-grid">
            ${resultsHTML}
        </div>
    `;
}

// Clear search results
function clearResults() {
  const resultsDiv = document.getElementById("searchResults");
  if (resultsDiv) {
    resultsDiv.innerHTML = "";
  }
}

// Test search functionality
function testSearch(term) {
  const searchInput = document.getElementById("voterSearch");
  if (searchInput) {
    searchInput.value = term;
    performSearch();
  }
}

// Polling Station Data and Analytics - Complete Dataset (171 stations)
const pollingStationData = [
  { station: "राजकीया मधय विद्यालय सीरखिरिया, सरखिरिया", count: 4800 },
  { station: "राजकीय मध्य विद्यालय, बघाड़ी", count: 4166 },
  { station: "राजकीय मध्य विद्यालय, रून्नीसैदपुर", count: 3986 },
  { station: "राजकीय मध्य विद्यालय, ओलीपुर", count: 3637 },
  { station: "राजकीय मध्य विद्यालय, बेलाही निलकंठ", count: 3505 },
  { station: "राजकीय मध्य विद्यालय, गाढ़ा", count: 3391 },
  {
    station:
      "राजकीया प्राथमिक विधालय कन्या प्रेमनगर गोट के प्रांगन मे चलंत मतदान",
    count: 3387,
  },
  { station: "राजकीय मध्य विद्यालय, थुम्मा-2", count: 3382 },
  { station: "राजकीय मध्य विद्यालय, महेशा-1", count: 3230 },
  { station: "बुनियादी विद्यालय, गौड़ा", count: 3224 },
  { station: "राजकीय मध्य विद्यालय, टिकौली", count: 3132 },
  { station: "राजकीय प्राथमिक विद्यालय, कन्या प्रेमनगर गोट", count: 3035 },
  { station: "पंचायत भवन, बघाड़ी", count: 3013 },
  { station: "राजकीय मध्य विधालय प्रखंड कॉलनी", count: 2796 },
  { station: "उत्क्रमित मध्य विद्यालय, बलिगढ", count: 2745 },
  { station: "राजकीय मध्य विद्यालय, रून्नी", count: 2683 },
  { station: "राजकीय मध्य विद्यालय, मेहसौल", count: 2660 },
  { station: "राजकीय मध्य विद्यालय पाठक टोला मानिक चौक", count: 2636 },
  { station: "राजकीय मध्य विद्यालय धनुषी", count: 2628 },
  { station: "मध्य विद्यालय, मौना उर्दु", count: 2616 },
  { station: "राजकीय मध्य विद्यालय, मोहनी", count: 2613 },
  { station: "मध्य विद्यालय मानपुर रत्नावली", count: 2546 },
  { station: "राजकीय मध्य विद्यालय, लालपुर कौड़िया", count: 2511 },
  { station: "राजकीय मध्य विद्यालय, खड़का", count: 2412 },
  { station: "राजकीय मध्य विद्यालय, कोदरिया", count: 2338 },
  { station: "राजकीय मध्य विद्यालय, महिन्दवारा", count: 2310 },
  { station: "राजकीय मध्य विद्यालय उर्दू गौसनगर", count: 2252 },
  { station: "राजकीय मध्य विद्यालय, गैघट बालक", count: 2225 },
  { station: "उत्क्रमित उच्च विद्यालय, बलुआ", count: 2220 },
  { station: "राजकीय प्राथमिक हिन्दी विद्यालय, गौसनगर", count: 2172 },
  { station: "उत्तक्रमित मध्य विद्यालय रसलपुर मलमला", count: 2164 },
  { station: "राजकीय मध्य विद्यालय खोपी", count: 2114 },
  { station: "उत्क्रमित मध्य विद्यालय, बासदेव", count: 2102 },
  { station: "राजकीय मध्य विद्यालय, गिद्धा", count: 2089 },
  {
    station: "मौजे किशोरी बालिका उच्चतर माध्यमिक विद्यालय मानिक चौक",
    count: 2085,
  },
  { station: "राजकीय मध्य कन्या विद्यालय, थुम्मा", count: 2046 },
  { station: "राजकीय प्राथमिक विद्यालय, बरहेता उर्दु", count: 2034 },
  { station: "पंचायत भवन टिकौली गंगवारा", count: 2021 },
  { station: "मदरसा रसीदिया, रायपुर", count: 2018 },
  { station: "कन्या उच्च विद्यालय, अथरी", count: 2010 },
  { station: "प्राथमिक विद्यालय लालपुर कौड़िया, लालपुर", count: 2008 },
  { station: "प्राथमिक विद्यालय जन शिक्षा केन्द्र धनुषी", count: 1988 },
  { station: "राजकीय मध्य विद्यालय, थुम्मा-1", count: 1981 },
  { station: "राजकीय मध्य विद्यालय, पुनरवाड़ा", count: 1959 },
  { station: "राजकीय मध्य विद्यालय अथरी बालक, अथरी", count: 1958 },
  { station: "पंचायत भवन, अथरी", count: 1951 },
  { station: "राजकीय मध्य विद्यालय, ताहीरपुर", count: 1926 },
  { station: "राजकीय मध्य विद्यालय मानिक चौक", count: 1905 },
  { station: "राजकीय मध्य विद्यालय, नुनौरा", count: 1904 },
  { station: "पंचायत भवन, सिरखिरिया", count: 1854 },
  { station: "राजकीय मध्य विद्यालय, नेउरी", count: 1848 },
  { station: "राजकीय प्राथमिक विद्यालय, रूदौली", count: 1840 },
  { station: "राजकीय मध्य विद्यालय, मेदनीपुर", count: 1833 },
  { station: "प्राथमिक विद्यालय, बलिगढ हरिजन", count: 1831 },
  { station: "राजकीय मध्य विद्यालय, पोता उर्फ तिलक ताजपुर कन्या", count: 1828 },
  { station: "सामुदायिक भवन, मानिक चौक", count: 1815 },
  { station: "कन्या प्राथमिक विद्यालय, साह टोला ओलीपुर", count: 1801 },
  { station: "राजकीय मध्य विद्यालय, गोविन्द पितौझिया", count: 1795 },
  { station: "राजकीय मध्य विद्यालय, रूपौली", count: 1786 },
  {
    station: "राजकीय प्राथमिक विद्यालय मानिक चौक (अनुसूचित जाति टोला)",
    count: 1764,
  },
  { station: "राजकीय मध्य विद्यालय, कोरलहिया हरिनारायण", count: 1759 },
  { station: "उच्च विद्यालय, रायपुर", count: 1758 },
  { station: "राजकीय मध्य विद्यालय, ठाहर", count: 1728 },
  { station: "राजकीय मध्य विद्यालय, मझौली उर्फ भनुडीह", count: 1691 },
  { station: "उत्क्रमिक मध्य विद्यालय दसई बालक", count: 1669 },
  { station: "राजकीय मध्य विद्यालय महिसार", count: 1660 },
  { station: "राजकीय मध्य विद्यालय, खरपटृी गंगवारा", count: 1656 },
  { station: "राजकीय प्राथमिक विद्यालय भरेहबा", count: 1636 },
  { station: "राजकीय प्राथमिक विद्यालय, हिरदोपट्टी", count: 1623 },
  { station: "शारदा संस्कृत विद्यालय मानिक चौक", count: 1619 },
  { station: "राजकीय प्राथमिक विद्यालय, पंडौल उर्दू", count: 1607 },
  { station: "उत्क्रमित मध्य विद्यालय, सुहईगढ़", count: 1604 },
  { station: "राजकीय मध्य विद्यालय बालक, रैन विशुनी", count: 1600 },
  { station: "राजकीय मध्य विद्यालय, फुलवरिया", count: 1593 },
  { station: "राजकीय मध्‍य विद्यालय, पोता उर्फ तिलकताजपुर", count: 1587 },
  { station: "प्राथमिक विद्यालय शिवनगर पुनर्वास, शिवनगर", count: 1583 },
  {
    station: "राजकीय प्राथमिक विद्यालय, मानिक चौक टोले हरसिंगपुर",
    count: 1557,
  },
  { station: "मध्य विद्यालय, भीमपुर भपुरा", count: 1556 },
  { station: "राजकीय मध्य विद्यालय, बाथ असली", count: 1522 },
  { station: "पंचायत भवन, मोरसंड", count: 1506 },
  { station: "राजकीय मध्य विद्यालय, रायपुर कन्या", count: 1506 },
  { station: "राजकीय मध्य विद्यालय, तरमा", count: 1504 },
  { station: "राजकीय प्राथमिक विद्यालय, सकरौली", count: 1503 },
  { station: "महंथ विजयानंद गिरि उच्च विद्यालय मानिक चौक", count: 1496 },
  { station: "राजकीय मध्य विद्यालय बतरा", count: 1486 },
  { station: "पंचायत भवन बाराडीह", count: 1484 },
  { station: "राजकीय मध्‍य विद्यालय, सुगरीडीह", count: 1473 },
  { station: "राजकीय मध्य विद्यालय, धकजरी", count: 1456 },
  { station: "पंचायत भवन, गौड़ा", count: 1437 },
  { station: "मध्य विद्यालय, खोपा", count: 1433 },
  { station: "उत्क्रमित मध्य विद्यालय, प्रेमनगर", count: 1432 },
  { station: "अनुसूचित जाति दलान, चमार टोल बाथ असली", count: 1420 },
  { station: "राजकीय मध्य विद्यालय, टोले गोरीगामा", count: 1404 },
  { station: "राजकीय प्राथमिक विद्यालय, रामनगर बगाही", count: 1403 },
  { station: "राजकीय मध्य विद्यालय, रामपुर", count: 1398 },
  { station: "राजकीय मध्य विद्यालय, विशनपुर", count: 1393 },
  { station: "राजकीय मध्य विद्यालय, समौल साहपुर", count: 1377 },
  { station: "उत्क्रमित मध्य विद्यालय, इब्राहीमपुर", count: 1375 },
  {
    station: "राजकीय प्राथमिक बालक विद्यालय, प्रेमनगर बहुरी टोला",
    count: 1355,
  },
  { station: "मध्य विद्यालय, माधोपुर सुलतानपुर", count: 1345 },
  { station: "राजकीय मध्य विद्यालय, हाजीपुर बसंत", count: 1341 },
  { station: "राजकीय मध्य विद्यालय बगाही", count: 1326 },
  { station: "राजकीय मध्य विद्यालय (बालक), मोरसंड", count: 1323 },
  { station: "राजकीय प्राथमिक विद्यालय, माधोपुर सारनाथ बालक", count: 1308 },
  { station: "राजकीय मध्य विद्यालय, चकदोनई", count: 1303 },
  { station: "मध्य विद्यालय, कोआही", count: 1288 },
  { station: "राजकीय मध्य विद्यालय, गंगवारा", count: 1268 },
  { station: "मध्य विद्यालय, मधौल", count: 1266 },
  { station: "कैलाशपति उच्च विद्यालय, अथरी", count: 1245 },
  { station: "राजकीय प्राथमिक विद्यालय, बघौनी", count: 1243 },
  { station: "नव निर्मित प्राथमिक विद्यालय, बेलहिया", count: 1240 },
  { station: "प्राथमिक विद्यालय ब्रह्मस्थान, हरसिंगपुर", count: 1222 },
  { station: "राजकीय प्राथमिक विद्यालय, हरदिया", count: 1213 },
  { station: "राजकीय मध्य विद्यालय रायपुर", count: 1206 },
  { station: "प्राथमिक विद्यालय, पोखरपुर", count: 1196 },
  { station: "राजकीय मध्य विद्यालय, उर्दू मेहसौल", count: 1191 },
  { station: "राजकीय मध्य विद्यालय, बुलन्दपुर उर्फ़ हुसैनपुर", count: 1180 },
  { station: "मखनु उच्च विद्यालय, तिलक ताजपुर", count: 1173 },
  { station: "राजकीय मध्य विद्यालय, चकवा", count: 1171 },
  { station: "राजकीय प्राथमिक विद्यालय फैजपुर उर्दू", count: 1161 },
  { station: "राजकीय मध्य विद्यालय, बसतपुर", count: 1151 },
  { station: "राजकीय मध्‍य विद्यालय, सोनपुरवा", count: 1148 },
  {
    station: "अनुसुचित जाति दलान, बाथ असली राम अधीन पासवान के घर के निकट",
    count: 1146,
  },
  { station: "राजकीय मध्य विद्यालय, रायपुर", count: 1134 },
  { station: "राजकीय मध्य विद्यालय, टोले भाले", count: 1133 },
  { station: "राजकीय प्राथमिक विद्यालय मधौल बालक", count: 1133 },
  { station: "राजकीय बुनियादी विद्यालय, मननपुर मोरसंड", count: 1119 },
  { station: "राजकीय मध्य विद्यालय बालक, कुंडल", count: 1099 },
  { station: "राजकीय मध्य विद्यालय पोता रमनगरा", count: 1092 },
  { station: "राजकीय प्राथमिक उर्दू विद्यालय, रकसिया रामपुर", count: 1085 },
  { station: "पुस्तकालय भवन, रैन विशुनी", count: 1068 },
  { station: "मध्य विधालय, बलिगढ", count: 1067 },
  { station: "राजकीय मध्य विद्यालय, चौपार खुर्द", count: 1061 },
  { station: "राजकीय प्रथमिक विद्यालय, बरहेता", count: 1047 },
  {
    station: "राजकीय प्राथमिक विद्यालय, पोता उर्फ तिलक ताजपुर पूर्वी टोला",
    count: 1041,
  },
  { station: "नवयुवक पुस्तकालय, मानिक चौक", count: 1005 },
  { station: "राजकीय प्राथमिक विद्यालय, चौपार कला", count: 993 },
  { station: "उत्क्रमित मध्य विद्यालय, रैनशंकर", count: 980 },
  { station: "व्यापार मंडल, रून्नीसैदपुर", count: 979 },
  { station: "अनुसूचित जाति बैठका चमार टोल रायपुर", count: 971 },
  {
    station: "प्राथमिक विद्यालय, बुलंदपुर उर्फ हुसैनपुर बलान टोला",
    count: 935,
  },
  { station: "राजकीय मध्य विद्यालय, भनसपटृी", count: 926 },
  { station: "उत्क्रमित मध्य विद्यालय, धनहरा", count: 923 },
  { station: "राजकीय प्राथमिक विद्यालय, कोडलहिया कन्या", count: 909 },
  { station: "राजकीय प्राथमिक विद्यालय, नौवाडीह", count: 904 },
  { station: "जनता पुस्तकालय गाढा", count: 893 },
  { station: "प्राथमिक विद्यालय लडकनिया बासदेव टोला", count: 889 },
  { station: "राजकीय प्राथमिक विद्यालय, खरहुँआ", count: 888 },
  { station: "राजकीय मध्य विद्यालय, गरगट्टा", count: 887 },
  { station: "राजकीय मध्य विद्यालय, बुलन्दपुर उर्फ हुसैनपुर", count: 886 },
  { station: "राजकीय मध्य विद्यालय, भनसपटर्ी", count: 882 },
  { station: "मध्य विद्यालय, भवानीपुर", count: 881 },
  { station: "राजकीय प्राथमिक विद्यालय, मधौलगढ", count: 871 },
  { station: "राजकीय कन्या मध्य विद्यालय, मोरसंड", count: 869 },
  { station: "राजकीय मध्य विद्यालय, मजरोहा", count: 863 },
  { station: "राजकीय प्राथमिक विद्यालय दिलावरपुर", count: 850 },
  { station: "राजकीय उत्क्रमित मध्य विद्यालय, महेशा", count: 832 },
  { station: "राजकीय प्राथमिक विद्यालय, बथुली उर्दू", count: 822 },
  { station: "राजकीय मध्य विद्यालय टकौर", count: 772 },
  { station: "राजकीय प्राथमिक विद्यालय, थुम्मा टोल", count: 765 },
  { station: "राजकीय मध्य विद्यालय वयना", count: 678 },
  { station: "उत्क्रमित मध्य विद्यालय सुमहौती", count: 590 },
  { station: "राजकीय मध्य विद्यालय अनन्त विशनपुर", count: 588 },
  { station: "राजकीय मध्य विद्यालय, चकशंभु", count: 577 },
  { station: "राजकीय मध्य विद्यालय, बतरौली", count: 569 },
  { station: "राजकीय मध्य विद्यालय, माधोपुर चौधरी", count: 559 },
  { station: "राजकीय प्राथमिक विधालय भरथी", count: 517 },
  { station: "राजकीय प्राथमिक विद्यालय कन्या, कुण्डल", count: 506 },
  { station: "मध्य विद्यालय हनुमाननगर, हनुमाननगर", count: 484 },
  { station: "राजकीय मध्य विद्यालय, रकसिया", count: 432 },
  { station: "राजकीय मध्य विद्यालय, धोबहा", count: 409 },
  { station: "राजकीय मध्य विद्यालय, हसनपुर", count: 328 },
];

// Initialize polling station analytics
function initPollingAnalytics() {
  if (
    typeof Plotly !== "undefined" &&
    document.getElementById("polling-chart")
  ) {
    showChart("bar");
  }
}

// Show different types of charts
function showChart(type) {
  const pollingChart = document.getElementById("polling-chart");
  const ageChart = document.getElementById("age-distribution-chart");
  if (!pollingChart || typeof Plotly === "undefined") return;

  // Update tab appearance
  document
    .querySelectorAll(".chart-tab")
    .forEach((tab) => tab.classList.remove("active"));
  document
    .querySelector(`[onclick="showChart('${type}')"]`)
    .classList.add("active");

  // Hide all charts
  pollingChart.style.display = "none";
  if (ageChart) ageChart.style.display = "none";

  switch (type) {
    case "bar":
      pollingChart.style.display = "block";
      showBarChart();
      break;
    case "pie":
      pollingChart.style.display = "block";
      showPieChart();
      break;
    case "age":
      if (ageChart) {
        ageChart.style.display = "block";
        showAgeDistributionChart();
      }
      break;
  }
}

// Bar Chart - All 171 polling stations with scrolling
function showBarChart() {
  const allStations = pollingStationData; // Show all 171 stations

  const trace = {
    x: allStations.map((d) => d.count),
    y: allStations.map((d) =>
      d.station.length > 50 ? d.station.substring(0, 50) + "..." : d.station
    ),
    type: "bar",
    orientation: "h",
    marker: {
      color: "rgba(255, 107, 53, 0.8)",
      line: {
        color: "rgba(255, 107, 53, 1.0)",
        width: 1,
      },
    },
    text: allStations.map((d) => d.count),
    textposition: "outside",
    textfont: {
      size: 11,
      color: "#2C3E50",
    },
  };

  const layout = {
    title: {
      text: "📊 सभी 171 मतदान केंद्र (मतदाता संख्या के आधार पर)",
      font: { size: 16, color: "#2C3E50", family: "Poppins" },
    },
    xaxis: {
      title: "मतदाताओं की संख्या",
      titlefont: { size: 14, color: "#2C3E50" },
    },
    yaxis: {
      title: "मतदान केंद्र",
      titlefont: { size: 14, color: "#2C3E50" },
      tickfont: { size: 9 },
    },
    margin: { l: 400, r: 100, t: 80, b: 80 }, // Increased left margin for long names
    plot_bgcolor: "rgba(0,0,0,0)",
    paper_bgcolor: "rgba(0,0,0,0)",
    showlegend: false,
  };

  const config = {
    responsive: true,
    scrollZoom: true,
    displayModeBar: true,
    modeBarButtonsToAdd: ["pan2d", "zoom2d"],
  };

  Plotly.newPlot("polling-chart", [trace], layout, config);
}

// Pie Chart - Top 10 polling stations
function showPieChart() {
  const top10 = pollingStationData.slice(0, 10);
  const others = pollingStationData.slice(10);
  const othersSum = others.reduce((sum, d) => sum + d.count, 0);

  const labels = [
    ...top10.map((d) =>
      d.station.length > 30 ? d.station.substring(0, 30) + "..." : d.station
    ),
    "अन्य केंद्र",
  ];
  const values = [...top10.map((d) => d.count), othersSum];

  const trace = {
    labels: labels,
    values: values,
    type: "pie",
    marker: {
      colors: [
        "#FF6B35",
        "#F7931E",
        "#FFE66D",
        "#27AE60",
        "#3498DB",
        "#9B59B6",
        "#E74C3C",
        "#95A5A6",
        "#F39C12",
        "#2ECC71",
        "#BDC3C7",
      ],
    },
    textinfo: "label+percent",
    textposition: "outside",
    textfont: {
      size: 11,
      color: "#2C3E50",
    },
  };

  const layout = {
    title: {
      text: "🥧 शीर्ष 10 मतदान केंद्र (प्रतिशत वितरण)",
      font: { size: 16, color: "#2C3E50", family: "Poppins" },
    },
    height: 600,
    margin: { l: 80, r: 80, t: 80, b: 80 },
    plot_bgcolor: "rgba(0,0,0,0)",
    paper_bgcolor: "rgba(0,0,0,0)",
    showlegend: false,
  };

  Plotly.newPlot("polling-chart", [trace], layout, { responsive: true });
}

// Age Distribution Chart - Interactive Histogram with 5-year bins
async function showAgeDistributionChart() {
  console.log("Creating age distribution chart...");

  // Collect age data from voter chunks or sample data
  let allAges = [];

  if (voterChunkIndex) {
    // Load all chunks and collect age data
    for (
      let i = 0;
      i < Math.min(10, voterChunkIndex.metadata.total_chunks);
      i++
    ) {
      // Limit to first 10 chunks for performance
      try {
        const chunkData = await loadChunk(i);
        const chunkAges = chunkData
          .filter((voter) => voter.a && voter.a > 0 && voter.a <= 120) // Valid ages only
          .map((voter) => voter.a);
        allAges.push(...chunkAges);
      } catch (error) {
        console.error(`Error loading chunk ${i} for age data:`, error);
      }
    }
  }

  // Fallback to sample data if no chunk data
  if (allAges.length === 0) {
    allAges = realVoterDataSample
      .filter((voter) => voter.age && voter.age > 0 && voter.age <= 120)
      .map((voter) => voter.age);
  }

  if (allAges.length === 0) {
    console.error("No age data available");
    return;
  }

  // Create 5-year age bins
  const minAge = Math.min(...allAges);
  const maxAge = Math.max(...allAges);
  const binSize = 5;
  const bins = [];
  const binLabels = [];
  const binCounts = [];

  // Create bins from minimum age to maximum age
  for (
    let age = Math.floor(minAge / binSize) * binSize;
    age <= maxAge;
    age += binSize
  ) {
    bins.push(age);
    binLabels.push(`${age}-${age + binSize - 1}`);

    // Count voters in this age range
    const count = allAges.filter((a) => a >= age && a < age + binSize).length;
    binCounts.push(count);
  }

  const trace = {
    x: binLabels,
    y: binCounts,
    type: "bar",
    marker: {
      color: "#4A90E2",
      line: {
        color: "#2C3E50",
        width: 1,
      },
    },
    hovertemplate:
      "<b>आयु समूह: %{x}</b><br>" +
      "मतदाता संख्या: %{y}<br>" +
      "<extra></extra>",
  };

  const layout = {
    title: {
      text: `👥 मतदाताओं का आयु वितरण (${allAges.length.toLocaleString(
        "hi-IN"
      )} नमूना)`,
      font: { size: 16, color: "#2C3E50", family: "Poppins" },
    },
    xaxis: {
      title: "आयु समूह (वर्ष)",
      titlefont: { color: "#2C3E50", size: 14 },
      tickfont: { color: "#2C3E50", size: 12 },
      gridcolor: "#E5E5E5",
    },
    yaxis: {
      title: "मतदाताओं की संख्या",
      titlefont: { color: "#2C3E50", size: 14 },
      tickfont: { color: "#2C3E50", size: 12 },
      gridcolor: "#E5E5E5",
    },
    plot_bgcolor: "rgba(0,0,0,0)",
    paper_bgcolor: "rgba(0,0,0,0)",
    height: 500,
    margin: { l: 80, r: 40, t: 80, b: 80 },
    hovermode: "closest",
  };

  const config = {
    responsive: true,
    displayModeBar: true,
    modeBarButtonsToRemove: ["pan2d", "lasso2d", "select2d", "autoScale2d"],
    displaylogo: false,
  };

  Plotly.newPlot("age-distribution-chart", [trace], layout, config);

  console.log(`Age distribution chart created with ${allAges.length} records`);
  console.log(`Age range: ${minAge}-${maxAge} years, Bins: ${bins.length}`);
}

// Update DOMContentLoaded to include polling analytics
document.addEventListener("DOMContentLoaded", function () {
  console.log("DOM loaded, initializing voter search...");

  // Initialize AOS (Animate On Scroll)
  if (typeof AOS !== "undefined") {
    AOS.init({
      duration: 800,
      easing: "ease-in-out",
      once: true,
      offset: 100,
    });
  }

  initializeRealData();
  setupEventListeners();

  // Initialize polling analytics with a delay to ensure Plotly is loaded
  setTimeout(() => {
    initPollingAnalytics();
  }, 1000);

  // Initialize map zoom functionality
  initMapZoom();
});

// Map zoom functionality
let currentZoom = 1;
let isDragging = false;
let dragStart = { x: 0, y: 0 };
let imagePosition = { x: 0, y: 0 };

function initMapZoom() {
  const mapImg = document.getElementById("mapImage");
  const mapWrapper = document.getElementById("mapWrapper");

  if (!mapImg || !mapWrapper) return;

  // Mouse wheel zoom
  mapWrapper.addEventListener("wheel", function (e) {
    e.preventDefault();
    const delta = e.deltaY > 0 ? -0.1 : 0.1;
    const newZoom = Math.max(1, Math.min(3, currentZoom + delta));
    setZoom(newZoom);
  });

  // Touch pinch zoom
  let initialDistance = 0;
  let initialZoom = 1;

  mapWrapper.addEventListener("touchstart", function (e) {
    if (e.touches.length === 2) {
      initialDistance = getDistance(e.touches[0], e.touches[1]);
      initialZoom = currentZoom;
      e.preventDefault();
    } else if (e.touches.length === 1 && currentZoom > 1) {
      startDrag(e.touches[0]);
    }
  });

  mapWrapper.addEventListener("touchmove", function (e) {
    if (e.touches.length === 2) {
      e.preventDefault();
      const distance = getDistance(e.touches[0], e.touches[1]);
      const scale = distance / initialDistance;
      const newZoom = Math.max(1, Math.min(3, initialZoom * scale));
      setZoom(newZoom);
    } else if (e.touches.length === 1 && isDragging && currentZoom > 1) {
      drag(e.touches[0]);
      e.preventDefault();
    }
  });

  mapWrapper.addEventListener("touchend", function (e) {
    if (e.touches.length === 0) {
      stopDrag();
    }
  });

  // Mouse drag
  mapImg.addEventListener("mousedown", function (e) {
    if (currentZoom > 1) {
      startDrag(e);
      e.preventDefault();
    }
  });

  document.addEventListener("mousemove", function (e) {
    if (isDragging && currentZoom > 1) {
      drag(e);
    }
  });

  document.addEventListener("mouseup", stopDrag);
}

function zoomMap(direction, mapId = 1) {
  const currentZoomKey = `currentZoom${mapId}`;
  let currentZoom = window[currentZoomKey] || 1;

  let newZoom;
  if (direction === "in") {
    newZoom = Math.min(3, currentZoom + 0.5);
  } else if (direction === "out") {
    newZoom = Math.max(1, currentZoom - 0.5);
  }
  setZoom(newZoom, mapId);
}

function resetZoom(mapId = 1) {
  setZoom(1, mapId);
  const positionKey = `imagePosition${mapId}`;
  window[positionKey] = { x: 0, y: 0 };
  updateImageTransform(mapId);
}

function toggleZoom(mapId = 1) {
  const currentZoomKey = `currentZoom${mapId}`;
  const currentZoom = window[currentZoomKey] || 1;
  const newZoom = currentZoom === 1 ? 2 : 1;
  setZoom(newZoom, mapId);
  if (newZoom === 1) {
    const positionKey = `imagePosition${mapId}`;
    window[positionKey] = { x: 0, y: 0 };
    updateImageTransform(mapId);
  }
}

function setZoom(zoom, mapId = 1) {
  const currentZoomKey = `currentZoom${mapId}`;
  window[currentZoomKey] = zoom;
  const mapImg = document.getElementById(`mapImage${mapId}`);

  if (!mapImg) return; // Safety check

  if (zoom === 1) {
    mapImg.classList.remove("zoomed", "draggable");
    const positionKey = `imagePosition${mapId}`;
    window[positionKey] = { x: 0, y: 0 };
  } else {
    mapImg.classList.add("zoomed", "draggable");
  }

  updateImageTransform(mapId);
}

function updateImageTransform(mapId = 1) {
  const mapImg = document.getElementById(`mapImage${mapId}`);
  const currentZoomKey = `currentZoom${mapId}`;
  const positionKey = `imagePosition${mapId}`;
  const currentZoom = window[currentZoomKey] || 1;
  const imagePosition = window[positionKey] || { x: 0, y: 0 };

  if (mapImg) {
    mapImg.style.transform = `scale(${currentZoom}) translate(${imagePosition.x}px, ${imagePosition.y}px)`;
  }
}

function startDrag(pointer) {
  if (currentZoom > 1) {
    isDragging = true;
    dragStart.x = pointer.clientX - imagePosition.x;
    dragStart.y = pointer.clientY - imagePosition.y;

    const mapImg = document.getElementById("mapImage");
    const mapWrapper = document.getElementById("mapWrapper");
    mapImg.classList.add("dragging");
    mapWrapper.classList.add("dragging");
  }
}

function drag(pointer) {
  if (!isDragging) return;

  const mapWrapper = document.getElementById("mapWrapper");
  const rect = mapWrapper.getBoundingClientRect();
  const maxX = (rect.width * (currentZoom - 1)) / (2 * currentZoom);
  const maxY = (rect.height * (currentZoom - 1)) / (2 * currentZoom);

  let newX = pointer.clientX - dragStart.x;
  let newY = pointer.clientY - dragStart.y;

  // Constrain movement
  newX = Math.max(-maxX, Math.min(maxX, newX));
  newY = Math.max(-maxY, Math.min(maxY, newY));

  imagePosition.x = newX;
  imagePosition.y = newY;
  updateImageTransform();
}

function stopDrag() {
  isDragging = false;
  const mapImg = document.getElementById("mapImage");
  const mapWrapper = document.getElementById("mapWrapper");
  mapImg.classList.remove("dragging");
  mapWrapper.classList.remove("dragging");
}

function getDistance(touch1, touch2) {
  const dx = touch1.clientX - touch2.clientX;
  const dy = touch1.clientY - touch2.clientY;
  return Math.sqrt(dx * dx + dy * dy);
}
